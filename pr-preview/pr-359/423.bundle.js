/*! For license information please see 423.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunk_aics_vole_app=self.webpackChunk_aics_vole_app||[]).push([[423],{9423:(t,e,s)=>{var i=s(205);class r extends Error{name="NonError";constructor(t){super(r._prepareSuperMessage(t))}static _prepareSuperMessage(t){try{return JSON.stringify(t)}catch{return String(t)}}}const n=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],a=new WeakSet,o=t=>i.A.get(t)??Error,h=({from:t,seen:e,to:s,forceEnumerable:i,maxDepth:r,depth:l,useToJSON:c,serialize:d})=>{if(s||(s=Array.isArray(t)?[]:!d&&u(t)?new(o(t.name)):{}),e.push(t),l>=r)return s;if(c&&"function"==typeof t.toJSON&&!a.has(t))return(t=>{a.add(t);const e=t.toJSON();return a.delete(t),e})(t);const m=t=>h({from:t,seen:[...e],forceEnumerable:i,maxDepth:r,depth:l,useToJSON:c,serialize:d});for(const[i,r]of Object.entries(t))if(r&&r instanceof Uint8Array&&"Buffer"===r.constructor.name)s[i]="[object Buffer]";else if(null===r||"object"!=typeof r||"function"!=typeof r.pipe){if("function"!=typeof r)if(r&&"object"==typeof r)e.includes(t[i])?s[i]="[Circular]":(l++,s[i]=m(t[i]));else try{s[i]=r}catch{}}else s[i]="[object Stream]";for(const{property:e,enumerable:r}of n)void 0!==t[e]&&null!==t[e]&&Object.defineProperty(s,e,{value:u(t[e])?m(t[e]):t[e],enumerable:!!i||r,configurable:!0,writable:!0});return s};function l(t,e={}){const{maxDepth:s=Number.POSITIVE_INFINITY,useToJSON:i=!0}=e;return"object"==typeof t&&null!==t?h({from:t,seen:[],forceEnumerable:!0,maxDepth:s,depth:0,useToJSON:i,serialize:!0}):"function"==typeof t?`[Function: ${t.name||"anonymous"}]`:t}function c(t,e={}){const{maxDepth:s=Number.POSITIVE_INFINITY}=e;if(t instanceof Error)return t;if(function(t){return Boolean(t)&&"object"==typeof t&&"message"in t&&!Array.isArray(t)}(t)){const e=o(t.name);return h({from:t,seen:[],to:new e,maxDepth:s,depth:0,serialize:!1})}return new r(t)}function u(t){return Boolean(t)&&"object"==typeof t&&"name"in t&&"message"in t&&"stack"in t}class d{constructor(t=25e7){this.entries=new Map,this.maxSize=t,this.currentSize=0,this.first=null,this.last=null}get size(){return this.currentSize}get numberOfEntries(){return this.entries.size}removeEntryFromStore(t){this.entries.delete(t.key),this.currentSize-=t.data.byteLength}removeEntryFromList(t){const{prev:e,next:s}=t;e?e.next=s:this.first=s,s?s.prev=e:this.last=e}addEntryAsFirst(t){this.first?this.first.prev=t:this.last=t,t.next=this.first,t.prev=null,this.first=t}moveEntryToFirst(t){t!==this.first&&(this.removeEntryFromList(t),this.addEntryAsFirst(t))}evictLast(){this.last?(this.removeEntryFromStore(this.last),this.last.prev&&(this.last.prev.next=null),this.last=this.last.prev):console.error("VolumeCache: attempt to evict last entry from cache when no last entry is set")}evict(t){this.removeEntryFromStore(t),this.removeEntryFromList(t)}insert(t,e){if(e.byteLength>this.maxSize)return console.error("VolumeCache: attempt to insert a single entry larger than the cache"),!1;const s=this.getEntry(t);if(void 0!==s)return s.data=e,!0;const i={data:e,prev:null,next:null,key:t};for(this.addEntryAsFirst(i),this.entries.set(t,i),this.currentSize+=e.byteLength;this.currentSize>this.maxSize;)this.evictLast();return!0}getEntry(t){const e=this.entries.get(t);return e&&this.moveEntryToFirst(e),e}get(t){return this.getEntry(t)?.data}clearWithPrefix(t){for(const[e,s]of this.entries.entries())e.startsWith(t)&&this.evict(s)}clear(){for(;this.last;)this.evictLast()}}const m=1001,p=1009,y=1029,f=2300,g=2301,x=2302,_="srgb",b="srgb-linear",w="linear",M="srgb";class v{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const s=this._listeners;void 0===s[t]&&(s[t]=[]),-1===s[t].indexOf(e)&&s[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const s=this._listeners;return void 0!==s[t]&&-1!==s[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const s=this._listeners[t];if(void 0!==s){const t=s.indexOf(e);-1!==t&&s.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const s=e.slice(0);for(let e=0,i=s.length;e<i;e++)s[e].call(this,t);t.target=null}}}const z=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function S(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(z[255&t]+z[t>>8&255]+z[t>>16&255]+z[t>>24&255]+"-"+z[255&e]+z[e>>8&255]+"-"+z[e>>16&15|64]+z[e>>24&255]+"-"+z[63&s|128]+z[s>>8&255]+"-"+z[s>>16&255]+z[s>>24&255]+z[255&i]+z[i>>8&255]+z[i>>16&255]+z[i>>24&255]).toLowerCase()}function A(t,e,s){return Math.max(e,Math.min(s,t))}function E(t,e,s){return(1-s)*t+s*e}Math.PI,Math.PI;class T{constructor(t=0,e=0){T.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6],this.y=i[1]*e+i[4]*s+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=A(this.x,t.x,e.x),this.y=A(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=A(this.x,t,e),this.y=A(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(A(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(A(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),i=Math.sin(e),r=this.x-t.x,n=this.y-t.y;return this.x=r*s-n*i+t.x,this.y=r*i+n*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class C{constructor(t,e,s,i,r,n,a,o,h){C.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,s,i,r,n,a,o,h)}set(t,e,s,i,r,n,a,o,h){const l=this.elements;return l[0]=t,l[1]=i,l[2]=a,l[3]=e,l[4]=r,l[5]=o,l[6]=s,l[7]=n,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],a=s[3],o=s[6],h=s[1],l=s[4],c=s[7],u=s[2],d=s[5],m=s[8],p=i[0],y=i[3],f=i[6],g=i[1],x=i[4],_=i[7],b=i[2],w=i[5],M=i[8];return r[0]=n*p+a*g+o*b,r[3]=n*y+a*x+o*w,r[6]=n*f+a*_+o*M,r[1]=h*p+l*g+c*b,r[4]=h*y+l*x+c*w,r[7]=h*f+l*_+c*M,r[2]=u*p+d*g+m*b,r[5]=u*y+d*x+m*w,r[8]=u*f+d*_+m*M,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*n*l-e*a*h-s*r*l+s*a*o+i*r*h-i*n*o}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=l*n-a*h,u=a*o-l*r,d=h*r-n*o,m=e*c+s*u+i*d;if(0===m)return this.set(0,0,0,0,0,0,0,0,0);const p=1/m;return t[0]=c*p,t[1]=(i*h-l*s)*p,t[2]=(a*s-i*n)*p,t[3]=u*p,t[4]=(l*e-i*o)*p,t[5]=(i*r-a*e)*p,t[6]=d*p,t[7]=(s*o-h*e)*p,t[8]=(n*e-s*r)*p,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,r,n,a){const o=Math.cos(r),h=Math.sin(r);return this.set(s*o,s*h,-s*(o*n+h*a)+n+t,-i*h,i*o,-i*(-h*n+o*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(I.makeScale(t,e)),this}rotate(t){return this.premultiply(I.makeRotation(-t)),this}translate(t,e){return this.premultiply(I.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const I=new C;function k(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;const D=(new C).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),N=(new C).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function L(){const t={enabled:!0,workingColorSpace:b,spaces:{},convert:function(t,e,s){return!1!==this.enabled&&e!==s&&e&&s?(this.spaces[e].transfer===M&&(t.r=R(t.r),t.g=R(t.g),t.b=R(t.b)),this.spaces[e].primaries!==this.spaces[s].primaries&&(t.applyMatrix3(this.spaces[e].toXYZ),t.applyMatrix3(this.spaces[s].fromXYZ)),this.spaces[s].transfer===M&&(t.r=P(t.r),t.g=P(t.g),t.b=P(t.b)),t):t},fromWorkingColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this.workingColorSpace)},getPrimaries:function(t){return this.spaces[t].primaries},getTransfer:function(t){return""===t?w:this.spaces[t].transfer},getLuminanceCoefficients:function(t,e=this.workingColorSpace){return t.fromArray(this.spaces[e].luminanceCoefficients)},define:function(t){Object.assign(this.spaces,t)},_getMatrix:function(t,e,s){return t.copy(this.spaces[e].toXYZ).multiply(this.spaces[s].fromXYZ)},_getDrawingBufferColorSpace:function(t){return this.spaces[t].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(t=this.workingColorSpace){return this.spaces[t].workingColorSpaceConfig.unpackColorSpace}},e=[.64,.33,.3,.6,.15,.06],s=[.2126,.7152,.0722],i=[.3127,.329];return t.define({[b]:{primaries:e,whitePoint:i,transfer:w,toXYZ:D,fromXYZ:N,luminanceCoefficients:s,workingColorSpaceConfig:{unpackColorSpace:_},outputColorSpaceConfig:{drawingBufferColorSpace:_}},[_]:{primaries:e,whitePoint:i,transfer:M,toXYZ:D,fromXYZ:N,luminanceCoefficients:s,outputColorSpaceConfig:{drawingBufferColorSpace:_}}}),t}const O=L();function R(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function P(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let U;class F{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===U&&(U=k("canvas")),U.width=t.width,U.height=t.height;const s=U.getContext("2d");t instanceof ImageData?s.putImageData(t,0,0):s.drawImage(t,0,0,t.width,t.height),e=U}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=k("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const i=s.getImageData(0,0,t.width,t.height),r=i.data;for(let t=0;t<r.length;t++)r[t]=255*R(r[t]/255);return s.putImageData(i,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*R(e[t]/255)):e[t]=R(e[t]);return{data:e,width:t.width,height:t.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let q=0;class V{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:q++}),this.uuid=S(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const s={uuid:this.uuid,url:""},i=this.data;if(null!==i){let t;if(Array.isArray(i)){t=[];for(let e=0,s=i.length;e<s;e++)i[e].isDataTexture?t.push(B(i[e].image)):t.push(B(i[e]))}else t=B(i);s.url=t}return e||(t.images[this.uuid]=s),s}}function B(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?F.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let j=0;class W extends v{constructor(t=W.DEFAULT_IMAGE,e=W.DEFAULT_MAPPING,s=1001,i=1001,r=1006,n=1008,a=1023,o=1009,h=W.DEFAULT_ANISOTROPY,l=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:j++}),this.uuid=S(),this.name="",this.source=new V(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=i,this.magFilter=r,this.minFilter=n,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new T(0,0),this.repeat=new T(1,1),this.center=new T(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new C,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=l,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const s={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case 1e3:t.x=t.x-Math.floor(t.x);break;case m:t.x=t.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case 1e3:t.y=t.y-Math.floor(t.y);break;case m:t.y=t.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}W.DEFAULT_IMAGE=null,W.DEFAULT_MAPPING=300,W.DEFAULT_ANISOTROPY=1,Symbol.iterator;class Y{constructor(t=0,e=0,s=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=i}static slerpFlat(t,e,s,i,r,n,a){let o=s[i+0],h=s[i+1],l=s[i+2],c=s[i+3];const u=r[n+0],d=r[n+1],m=r[n+2],p=r[n+3];if(0===a)return t[e+0]=o,t[e+1]=h,t[e+2]=l,void(t[e+3]=c);if(1===a)return t[e+0]=u,t[e+1]=d,t[e+2]=m,void(t[e+3]=p);if(c!==p||o!==u||h!==d||l!==m){let t=1-a;const e=o*u+h*d+l*m+c*p,s=e>=0?1:-1,i=1-e*e;if(i>Number.EPSILON){const r=Math.sqrt(i),n=Math.atan2(r,e*s);t=Math.sin(t*n)/r,a=Math.sin(a*n)/r}const r=a*s;if(o=o*t+u*r,h=h*t+d*r,l=l*t+m*r,c=c*t+p*r,t===1-a){const t=1/Math.sqrt(o*o+h*h+l*l+c*c);o*=t,h*=t,l*=t,c*=t}}t[e]=o,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,s,i,r,n){const a=s[i],o=s[i+1],h=s[i+2],l=s[i+3],c=r[n],u=r[n+1],d=r[n+2],m=r[n+3];return t[e]=a*m+l*c+o*d-h*u,t[e+1]=o*m+l*u+h*c-a*d,t[e+2]=h*m+l*d+a*u-o*c,t[e+3]=l*m-a*c-o*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,i=t._y,r=t._z,n=t._order,a=Math.cos,o=Math.sin,h=a(s/2),l=a(i/2),c=a(r/2),u=o(s/2),d=o(i/2),m=o(r/2);switch(n){case"XYZ":this._x=u*l*c+h*d*m,this._y=h*d*c-u*l*m,this._z=h*l*m+u*d*c,this._w=h*l*c-u*d*m;break;case"YXZ":this._x=u*l*c+h*d*m,this._y=h*d*c-u*l*m,this._z=h*l*m-u*d*c,this._w=h*l*c+u*d*m;break;case"ZXY":this._x=u*l*c-h*d*m,this._y=h*d*c+u*l*m,this._z=h*l*m+u*d*c,this._w=h*l*c-u*d*m;break;case"ZYX":this._x=u*l*c-h*d*m,this._y=h*d*c+u*l*m,this._z=h*l*m-u*d*c,this._w=h*l*c+u*d*m;break;case"YZX":this._x=u*l*c+h*d*m,this._y=h*d*c+u*l*m,this._z=h*l*m-u*d*c,this._w=h*l*c-u*d*m;break;case"XZY":this._x=u*l*c-h*d*m,this._y=h*d*c-u*l*m,this._z=h*l*m+u*d*c,this._w=h*l*c+u*d*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],r=e[8],n=e[1],a=e[5],o=e[9],h=e[2],l=e[6],c=e[10],u=s+a+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-o)*t,this._y=(r-h)*t,this._z=(n-i)*t}else if(s>a&&s>c){const t=2*Math.sqrt(1+s-a-c);this._w=(l-o)/t,this._x=.25*t,this._y=(i+n)/t,this._z=(r+h)/t}else if(a>c){const t=2*Math.sqrt(1+a-s-c);this._w=(r-h)/t,this._x=(i+n)/t,this._y=.25*t,this._z=(o+l)/t}else{const t=2*Math.sqrt(1+c-s-a);this._w=(n-i)/t,this._x=(r+h)/t,this._y=(o+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<Number.EPSILON?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(A(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(0===s)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,r=t._z,n=t._w,a=e._x,o=e._y,h=e._z,l=e._w;return this._x=s*l+n*a+i*h-r*o,this._y=i*l+n*o+r*a-s*h,this._z=r*l+n*h+s*o-i*a,this._w=n*l-s*a-i*o-r*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const s=this._x,i=this._y,r=this._z,n=this._w;let a=n*t._w+s*t._x+i*t._y+r*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=n,this._x=s,this._y=i,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*n+e*this._w,this._x=t*s+e*this._x,this._y=t*i+e*this._y,this._z=t*r+e*this._z,this.normalize(),this}const h=Math.sqrt(o),l=Math.atan2(h,a),c=Math.sin((1-e)*l)/h,u=Math.sin(e*l)/h;return this._w=n*c+this._w*u,this._x=s*c+this._x*u,this._y=i*c+this._y*u,this._z=r*c+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(i*Math.sin(t),i*Math.cos(t),r*Math.sin(e),r*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Z{constructor(t=0,e=0,s=0){Z.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return void 0===s&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(X.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(X.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*i,this.y=r[1]*e+r[4]*s+r[7]*i,this.z=r[2]*e+r[5]*s+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,n=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*n,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*n,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*n,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,r=t.x,n=t.y,a=t.z,o=t.w,h=2*(n*i-a*s),l=2*(a*e-r*i),c=2*(r*s-n*e);return this.x=e+o*h+n*c-a*l,this.y=s+o*l+a*h-r*c,this.z=i+o*c+r*l-n*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=A(this.x,t.x,e.x),this.y=A(this.y,t.y,e.y),this.z=A(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=A(this.x,t,e),this.y=A(this.y,t,e),this.z=A(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(A(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,n=e.x,a=e.y,o=e.z;return this.x=i*o-r*a,this.y=r*n-s*o,this.z=s*a-i*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return H.copy(this).projectOnVector(t),this.sub(H)}reflect(t){return this.sub(H.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(A(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const H=new Z,X=new Y;class ${constructor(t=new Z(1/0,1/0,1/0),e=new Z(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(G.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(G.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=G.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(void 0!==s){const i=s.getAttribute("position");if(!0===e&&void 0!==i&&!0!==t.isInstancedMesh)for(let e=0,s=i.count;e<s;e++)!0===t.isMesh?t.getVertexPosition(e,G):G.fromBufferAttribute(i,e),G.applyMatrix4(t.matrixWorld),this.expandByPoint(G);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),Q.copy(t.boundingBox)):(null===s.boundingBox&&s.computeBoundingBox(),Q.copy(s.boundingBox)),Q.applyMatrix4(t.matrixWorld),this.union(Q)}const i=t.children;for(let t=0,s=i.length;t<s;t++)this.expandByObject(i[t],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,G),G.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(nt),at.subVectors(this.max,nt),K.subVectors(t.a,nt),tt.subVectors(t.b,nt),et.subVectors(t.c,nt),st.subVectors(tt,K),it.subVectors(et,tt),rt.subVectors(K,et);let e=[0,-st.z,st.y,0,-it.z,it.y,0,-rt.z,rt.y,st.z,0,-st.x,it.z,0,-it.x,rt.z,0,-rt.x,-st.y,st.x,0,-it.y,it.x,0,-rt.y,rt.x,0];return!!lt(e,K,tt,et,at)&&(e=[1,0,0,0,1,0,0,0,1],!!lt(e,K,tt,et,at)&&(ot.crossVectors(st,it),e=[ot.x,ot.y,ot.z],lt(e,K,tt,et,at)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,G).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(G).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(J[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),J[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),J[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),J[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),J[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),J[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),J[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),J[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(J)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const J=[new Z,new Z,new Z,new Z,new Z,new Z,new Z,new Z],G=new Z,Q=new $,K=new Z,tt=new Z,et=new Z,st=new Z,it=new Z,rt=new Z,nt=new Z,at=new Z,ot=new Z,ht=new Z;function lt(t,e,s,i,r){for(let n=0,a=t.length-3;n<=a;n+=3){ht.fromArray(t,n);const a=r.x*Math.abs(ht.x)+r.y*Math.abs(ht.y)+r.z*Math.abs(ht.z),o=e.dot(ht),h=s.dot(ht),l=i.dot(ht);if(Math.max(-Math.max(o,h,l),Math.min(o,h,l))>a)return!1}return!0}class ct{constructor(t,e,s,i,r,n,a,o,h,l,c,u,d,m,p,y){ct.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,s,i,r,n,a,o,h,l,c,u,d,m,p,y)}set(t,e,s,i,r,n,a,o,h,l,c,u,d,m,p,y){const f=this.elements;return f[0]=t,f[4]=e,f[8]=s,f[12]=i,f[1]=r,f[5]=n,f[9]=a,f[13]=o,f[2]=h,f[6]=l,f[10]=c,f[14]=u,f[3]=d,f[7]=m,f[11]=p,f[15]=y,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new ct).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,i=1/ut.setFromMatrixColumn(t,0).length(),r=1/ut.setFromMatrixColumn(t,1).length(),n=1/ut.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*n,e[9]=s[9]*n,e[10]=s[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,i=t.y,r=t.z,n=Math.cos(s),a=Math.sin(s),o=Math.cos(i),h=Math.sin(i),l=Math.cos(r),c=Math.sin(r);if("XYZ"===t.order){const t=n*l,s=n*c,i=a*l,r=a*c;e[0]=o*l,e[4]=-o*c,e[8]=h,e[1]=s+i*h,e[5]=t-r*h,e[9]=-a*o,e[2]=r-t*h,e[6]=i+s*h,e[10]=n*o}else if("YXZ"===t.order){const t=o*l,s=o*c,i=h*l,r=h*c;e[0]=t+r*a,e[4]=i*a-s,e[8]=n*h,e[1]=n*c,e[5]=n*l,e[9]=-a,e[2]=s*a-i,e[6]=r+t*a,e[10]=n*o}else if("ZXY"===t.order){const t=o*l,s=o*c,i=h*l,r=h*c;e[0]=t-r*a,e[4]=-n*c,e[8]=i+s*a,e[1]=s+i*a,e[5]=n*l,e[9]=r-t*a,e[2]=-n*h,e[6]=a,e[10]=n*o}else if("ZYX"===t.order){const t=n*l,s=n*c,i=a*l,r=a*c;e[0]=o*l,e[4]=i*h-s,e[8]=t*h+r,e[1]=o*c,e[5]=r*h+t,e[9]=s*h-i,e[2]=-h,e[6]=a*o,e[10]=n*o}else if("YZX"===t.order){const t=n*o,s=n*h,i=a*o,r=a*h;e[0]=o*l,e[4]=r-t*c,e[8]=i*c+s,e[1]=c,e[5]=n*l,e[9]=-a*l,e[2]=-h*l,e[6]=s*c+i,e[10]=t-r*c}else if("XZY"===t.order){const t=n*o,s=n*h,i=a*o,r=a*h;e[0]=o*l,e[4]=-c,e[8]=h*l,e[1]=t*c+r,e[5]=n*l,e[9]=s*c-i,e[2]=i*c-s,e[6]=a*l,e[10]=r*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(mt,t,pt)}lookAt(t,e,s){const i=this.elements;return gt.subVectors(t,e),0===gt.lengthSq()&&(gt.z=1),gt.normalize(),yt.crossVectors(s,gt),0===yt.lengthSq()&&(1===Math.abs(s.z)?gt.x+=1e-4:gt.z+=1e-4,gt.normalize(),yt.crossVectors(s,gt)),yt.normalize(),ft.crossVectors(gt,yt),i[0]=yt.x,i[4]=ft.x,i[8]=gt.x,i[1]=yt.y,i[5]=ft.y,i[9]=gt.y,i[2]=yt.z,i[6]=ft.z,i[10]=gt.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],a=s[4],o=s[8],h=s[12],l=s[1],c=s[5],u=s[9],d=s[13],m=s[2],p=s[6],y=s[10],f=s[14],g=s[3],x=s[7],_=s[11],b=s[15],w=i[0],M=i[4],v=i[8],z=i[12],S=i[1],A=i[5],E=i[9],T=i[13],C=i[2],I=i[6],k=i[10],D=i[14],N=i[3],L=i[7],O=i[11],R=i[15];return r[0]=n*w+a*S+o*C+h*N,r[4]=n*M+a*A+o*I+h*L,r[8]=n*v+a*E+o*k+h*O,r[12]=n*z+a*T+o*D+h*R,r[1]=l*w+c*S+u*C+d*N,r[5]=l*M+c*A+u*I+d*L,r[9]=l*v+c*E+u*k+d*O,r[13]=l*z+c*T+u*D+d*R,r[2]=m*w+p*S+y*C+f*N,r[6]=m*M+p*A+y*I+f*L,r[10]=m*v+p*E+y*k+f*O,r[14]=m*z+p*T+y*D+f*R,r[3]=g*w+x*S+_*C+b*N,r[7]=g*M+x*A+_*I+b*L,r[11]=g*v+x*E+_*k+b*O,r[15]=g*z+x*T+_*D+b*R,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],r=t[12],n=t[1],a=t[5],o=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+r*o*c-i*h*c-r*a*u+s*h*u+i*a*d-s*o*d)+t[7]*(+e*o*d-e*h*u+r*n*u-i*n*d+i*h*l-r*o*l)+t[11]*(+e*h*c-e*a*d-r*n*c+s*n*d+r*a*l-s*h*l)+t[15]*(-i*a*l-e*o*c+e*a*u+i*n*c-s*n*u+s*o*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11],m=t[12],p=t[13],y=t[14],f=t[15],g=c*y*h-p*u*h+p*o*d-a*y*d-c*o*f+a*u*f,x=m*u*h-l*y*h-m*o*d+n*y*d+l*o*f-n*u*f,_=l*p*h-m*c*h+m*a*d-n*p*d-l*a*f+n*c*f,b=m*c*o-l*p*o-m*a*u+n*p*u+l*a*y-n*c*y,w=e*g+s*x+i*_+r*b;if(0===w)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const M=1/w;return t[0]=g*M,t[1]=(p*u*r-c*y*r-p*i*d+s*y*d+c*i*f-s*u*f)*M,t[2]=(a*y*r-p*o*r+p*i*h-s*y*h-a*i*f+s*o*f)*M,t[3]=(c*o*r-a*u*r-c*i*h+s*u*h+a*i*d-s*o*d)*M,t[4]=x*M,t[5]=(l*y*r-m*u*r+m*i*d-e*y*d-l*i*f+e*u*f)*M,t[6]=(m*o*r-n*y*r-m*i*h+e*y*h+n*i*f-e*o*f)*M,t[7]=(n*u*r-l*o*r+l*i*h-e*u*h-n*i*d+e*o*d)*M,t[8]=_*M,t[9]=(m*c*r-l*p*r-m*s*d+e*p*d+l*s*f-e*c*f)*M,t[10]=(n*p*r-m*a*r+m*s*h-e*p*h-n*s*f+e*a*f)*M,t[11]=(l*a*r-n*c*r-l*s*h+e*c*h+n*s*d-e*a*d)*M,t[12]=b*M,t[13]=(l*p*i-m*c*i+m*s*u-e*p*u-l*s*y+e*c*y)*M,t[14]=(m*a*i-n*p*i-m*s*o+e*p*o+n*s*y-e*a*y)*M,t[15]=(n*c*i-l*a*i+l*s*o-e*c*o-n*s*u+e*a*u)*M,this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),r=1-s,n=t.x,a=t.y,o=t.z,h=r*n,l=r*a;return this.set(h*n+s,h*a-i*o,h*o+i*a,0,h*a+i*o,l*a+s,l*o-i*n,0,h*o-i*a,l*o+i*n,r*o*o+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,i,r,n){return this.set(1,s,r,0,t,1,n,0,e,i,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,r=e._x,n=e._y,a=e._z,o=e._w,h=r+r,l=n+n,c=a+a,u=r*h,d=r*l,m=r*c,p=n*l,y=n*c,f=a*c,g=o*h,x=o*l,_=o*c,b=s.x,w=s.y,M=s.z;return i[0]=(1-(p+f))*b,i[1]=(d+_)*b,i[2]=(m-x)*b,i[3]=0,i[4]=(d-_)*w,i[5]=(1-(u+f))*w,i[6]=(y+g)*w,i[7]=0,i[8]=(m+x)*M,i[9]=(y-g)*M,i[10]=(1-(u+p))*M,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;let r=ut.set(i[0],i[1],i[2]).length();const n=ut.set(i[4],i[5],i[6]).length(),a=ut.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],dt.copy(this);const o=1/r,h=1/n,l=1/a;return dt.elements[0]*=o,dt.elements[1]*=o,dt.elements[2]*=o,dt.elements[4]*=h,dt.elements[5]*=h,dt.elements[6]*=h,dt.elements[8]*=l,dt.elements[9]*=l,dt.elements[10]*=l,e.setFromRotationMatrix(dt),s.x=r,s.y=n,s.z=a,this}makePerspective(t,e,s,i,r,n,a=2e3){const o=this.elements,h=2*r/(e-t),l=2*r/(s-i),c=(e+t)/(e-t),u=(s+i)/(s-i);let d,m;if(2e3===a)d=-(n+r)/(n-r),m=-2*n*r/(n-r);else{if(2001!==a)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);d=-n/(n-r),m=-n*r/(n-r)}return o[0]=h,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=l,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=m,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,s,i,r,n,a=2e3){const o=this.elements,h=1/(e-t),l=1/(s-i),c=1/(n-r),u=(e+t)*h,d=(s+i)*l;let m,p;if(2e3===a)m=(n+r)*c,p=-2*c;else{if(2001!==a)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);m=r*c,p=-1*c}return o[0]=2*h,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*l,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=p,o[14]=-m,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const ut=new Z,dt=new ct,mt=new Z(0,0,0),pt=new Z(1,1,1),yt=new Z,ft=new Z,gt=new Z,xt=new ct,_t=new Y;class bt{constructor(t=0,e=0,s=0,i=bt.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,i=this._order){return this._x=t,this._y=e,this._z=s,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const i=t.elements,r=i[0],n=i[4],a=i[8],o=i[1],h=i[5],l=i[9],c=i[2],u=i[6],d=i[10];switch(e){case"XYZ":this._y=Math.asin(A(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-n,r)):(this._x=Math.atan2(u,h),this._z=0);break;case"YXZ":this._x=Math.asin(-A(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,h)):(this._y=Math.atan2(-c,r),this._z=0);break;case"ZXY":this._x=Math.asin(A(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-c,d),this._z=Math.atan2(-n,h)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-A(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-n,h));break;case"YZX":this._z=Math.asin(A(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-c,r)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-A(n,-1,1)),Math.abs(n)<.9999999?(this._x=Math.atan2(u,h),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-l,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!0===s&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return xt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(xt,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return _t.setFromEuler(this),this.setFromQuaternion(_t,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}bt.DEFAULT_ORDER="XYZ";class wt{constructor(){this.mask=1}set(t){this.mask=1<<t>>>0}enable(t){this.mask|=1<<t}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t}disable(t){this.mask&=~(1<<t)}disableAll(){this.mask=0}test(t){return!!(this.mask&t.mask)}isEnabled(t){return!!(this.mask&1<<t)}}let Mt=0;const vt=new Z,zt=new Y,St=new ct,At=new Z,Et=new Z,Tt=new Z,Ct=new Y,It=new Z(1,0,0),kt=new Z(0,1,0),Dt=new Z(0,0,1),Nt={type:"added"},Lt={type:"removed"},Ot={type:"childadded",child:null},Rt={type:"childremoved",child:null};class Pt extends v{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Mt++}),this.uuid=S(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Pt.DEFAULT_UP.clone();const t=new Z,e=new bt,s=new Y,i=new Z(1,1,1);e._onChange((function(){s.setFromEuler(e,!1)})),s._onChange((function(){e.setFromQuaternion(s,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new ct},normalMatrix:{value:new C}}),this.matrix=new ct,this.matrixWorld=new ct,this.matrixAutoUpdate=Pt.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Pt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new wt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return zt.setFromAxisAngle(t,e),this.quaternion.multiply(zt),this}rotateOnWorldAxis(t,e){return zt.setFromAxisAngle(t,e),this.quaternion.premultiply(zt),this}rotateX(t){return this.rotateOnAxis(It,t)}rotateY(t){return this.rotateOnAxis(kt,t)}rotateZ(t){return this.rotateOnAxis(Dt,t)}translateOnAxis(t,e){return vt.copy(t).applyQuaternion(this.quaternion),this.position.add(vt.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(It,t)}translateY(t){return this.translateOnAxis(kt,t)}translateZ(t){return this.translateOnAxis(Dt,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(St.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?At.copy(t):At.set(t,e,s);const i=this.parent;this.updateWorldMatrix(!0,!1),Et.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?St.lookAt(Et,At,this.up):St.lookAt(At,Et,this.up),this.quaternion.setFromRotationMatrix(St),i&&(St.extractRotation(i.matrixWorld),zt.setFromRotationMatrix(St),this.quaternion.premultiply(zt.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(Nt),Ot.child=t,this.dispatchEvent(Ot),Ot.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Lt),Rt.child=t,this.dispatchEvent(Rt),Rt.child=null),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),St.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),St.multiply(t.parent.matrixWorld)),t.applyMatrix4(St),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(Nt),Ot.child=t,this.dispatchEvent(Ot),Ot.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,i=this.children.length;s<i;s++){const i=this.children[s].getObjectByProperty(t,e);if(void 0!==i)return i}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Et,t,Tt),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Et,Ct,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].updateMatrixWorld(t)}updateWorldMatrix(t,e){const s=this.parent;if(!0===t&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].updateWorldMatrix(!1,!0)}}toJSON(t){const e=void 0===t||"string"==typeof t,s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};function r(e,s){return void 0===e[s.uuid]&&(e[s.uuid]=s.toJSON(t)),s.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map((t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()}))),i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(t),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(t)),null!==this.boundingSphere&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),null!==this.boundingBox&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const s=e.shapes;if(Array.isArray(s))for(let e=0,i=s.length;e<i;e++){const i=s[e];r(t.shapes,i)}else r(t.shapes,s)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let s=0,i=this.material.length;s<i;s++)e.push(r(t.materials,this.material[s]));i.material=e}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let e=0;e<this.children.length;e++)i.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let e=0;e<this.animations.length;e++){const s=this.animations[e];i.animations.push(r(t.animations,s))}}if(e){const e=n(t.geometries),i=n(t.materials),r=n(t.textures),a=n(t.images),o=n(t.shapes),h=n(t.skeletons),l=n(t.animations),c=n(t.nodes);e.length>0&&(s.geometries=e),i.length>0&&(s.materials=i),r.length>0&&(s.textures=r),a.length>0&&(s.images=a),o.length>0&&(s.shapes=o),h.length>0&&(s.skeletons=h),l.length>0&&(s.animations=l),c.length>0&&(s.nodes=c)}return s.object=i,s;function n(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const s=t.children[e];this.add(s.clone())}return this}}Pt.DEFAULT_UP=new Z(0,1,0),Pt.DEFAULT_MATRIX_AUTO_UPDATE=!0,Pt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Ut={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Ft={h:0,s:0,l:0},qt={h:0,s:0,l:0};function Vt(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+6*(e-t)*(2/3-s):t}class Bt{constructor(t,e,s){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,s)}set(t,e,s){if(void 0===e&&void 0===s){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,s);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=_){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,O.toWorkingColorSpace(this,e),this}setRGB(t,e,s,i=O.workingColorSpace){return this.r=t,this.g=e,this.b=s,O.toWorkingColorSpace(this,i),this}setHSL(t,e,s,i=O.workingColorSpace){if(t=(t%(r=1)+r)%r,e=A(e,0,1),s=A(s,0,1),0===e)this.r=this.g=this.b=s;else{const i=s<=.5?s*(1+e):s+e-s*e,r=2*s-i;this.r=Vt(r,i,t+1/3),this.g=Vt(r,i,t),this.b=Vt(r,i,t-1/3)}var r;return O.toWorkingColorSpace(this,i),this}setStyle(t,e=_){function s(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(t)){let r;const n=i[1],a=i[2];switch(n){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,e);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,e);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,e);break;default:console.warn("THREE.Color: Unknown color model "+t)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const s=i[1],r=s.length;if(3===r)return this.setRGB(parseInt(s.charAt(0),16)/15,parseInt(s.charAt(1),16)/15,parseInt(s.charAt(2),16)/15,e);if(6===r)return this.setHex(parseInt(s,16),e);console.warn("THREE.Color: Invalid hex color "+t)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=_){const s=Ut[t.toLowerCase()];return void 0!==s?this.setHex(s,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=R(t.r),this.g=R(t.g),this.b=R(t.b),this}copyLinearToSRGB(t){return this.r=P(t.r),this.g=P(t.g),this.b=P(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=_){return O.fromWorkingColorSpace(jt.copy(this),t),65536*Math.round(A(255*jt.r,0,255))+256*Math.round(A(255*jt.g,0,255))+Math.round(A(255*jt.b,0,255))}getHexString(t=_){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=O.workingColorSpace){O.fromWorkingColorSpace(jt.copy(this),e);const s=jt.r,i=jt.g,r=jt.b,n=Math.max(s,i,r),a=Math.min(s,i,r);let o,h;const l=(a+n)/2;if(a===n)o=0,h=0;else{const t=n-a;switch(h=l<=.5?t/(n+a):t/(2-n-a),n){case s:o=(i-r)/t+(i<r?6:0);break;case i:o=(r-s)/t+2;break;case r:o=(s-i)/t+4}o/=6}return t.h=o,t.s=h,t.l=l,t}getRGB(t,e=O.workingColorSpace){return O.fromWorkingColorSpace(jt.copy(this),e),t.r=jt.r,t.g=jt.g,t.b=jt.b,t}getStyle(t=_){O.fromWorkingColorSpace(jt.copy(this),t);const e=jt.r,s=jt.g,i=jt.b;return t!==_?`color(${t} ${e.toFixed(3)} ${s.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*s)},${Math.round(255*i)})`}offsetHSL(t,e,s){return this.getHSL(Ft),this.setHSL(Ft.h+t,Ft.s+e,Ft.l+s)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,s){return this.r=t.r+(e.r-t.r)*s,this.g=t.g+(e.g-t.g)*s,this.b=t.b+(e.b-t.b)*s,this}lerpHSL(t,e){this.getHSL(Ft),t.getHSL(qt);const s=E(Ft.h,qt.h,e),i=E(Ft.s,qt.s,e),r=E(Ft.l,qt.l,e);return this.setHSL(s,i,r),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,s=this.g,i=this.b,r=t.elements;return this.r=r[0]*e+r[3]*s+r[6]*i,this.g=r[1]*e+r[4]*s+r[7]*i,this.b=r[2]*e+r[5]*s+r[8]*i,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const jt=new Bt;Bt.NAMES=Ut;class Wt extends W{constructor(t=null,e=1,s=1,i,r,n,a,o,h=1003,l=1003,c,u){super(null,n,a,o,h,l,i,r,c,u),this.isDataTexture=!0,this.image={data:t,width:e,height:s},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}function Yt(t,e,s){return!t||!s&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)}class Zt{constructor(t,e,s,i){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new e.constructor(s),this.sampleValues=e,this.valueSize=s,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let s=this._cachedIndex,i=e[s],r=e[s-1];t:{e:{let n;s:{i:if(!(t<i)){for(let n=s+2;;){if(void 0===i){if(t<r)break i;return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}if(s===n)break;if(r=i,i=e[++s],t<i)break e}n=e.length;break s}if(t>=r)break t;{const a=e[1];t<a&&(s=2,r=a);for(let n=s-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(s===n)break;if(i=r,r=e[--s-1],t>=r)break e}n=s,s=0}}for(;s<n;){const i=s+n>>>1;t<e[i]?n=i:s=i+1}if(i=e[s],r=e[s-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===i)return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}this._cachedIndex=s,this.intervalChanged_(s,r,i)}return this.interpolate_(s,r,t,i)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=t*i;for(let t=0;t!==i;++t)e[t]=s[r+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Ht extends Zt{constructor(t,e,s,i){super(t,e,s,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(t,e,s){const i=this.parameterPositions;let r=t-2,n=t+1,a=i[r],o=i[n];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:r=t,a=2*e-s;break;case 2402:r=i.length-2,a=e+i[r]-i[r+1];break;default:r=t,a=s}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:n=t,o=2*s-e;break;case 2402:n=1,o=s+i[1]-i[0];break;default:n=t-1,o=e}const h=.5*(s-e),l=this.valueSize;this._weightPrev=h/(e-a),this._weightNext=h/(o-s),this._offsetPrev=r*l,this._offsetNext=n*l}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=this._offsetPrev,c=this._offsetNext,u=this._weightPrev,d=this._weightNext,m=(s-e)/(i-e),p=m*m,y=p*m,f=-u*y+2*u*p-u*m,g=(1+u)*y+(-1.5-2*u)*p+(-.5+u)*m+1,x=(-1-d)*y+(1.5+d)*p+.5*m,_=d*y-d*p;for(let t=0;t!==a;++t)r[t]=f*n[l+t]+g*n[h+t]+x*n[o+t]+_*n[c+t];return r}}class Xt extends Zt{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=(s-e)/(i-e),c=1-l;for(let t=0;t!==a;++t)r[t]=n[h+t]*c+n[o+t]*l;return r}}class $t extends Zt{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t){return this.copySampleValue_(t-1)}}class Jt{constructor(t,e,s,i){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=Yt(e,this.TimeBufferType),this.values=Yt(s,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let s;if(e.toJSON!==this.toJSON)s=e.toJSON(t);else{s={name:t.name,times:Yt(t.times,Array),values:Yt(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(s.interpolation=e)}return s.type=t.ValueTypeName,s}InterpolantFactoryMethodDiscrete(t){return new $t(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new Xt(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new Ht(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let e;switch(t){case f:e=this.InterpolantFactoryMethodDiscrete;break;case g:e=this.InterpolantFactoryMethodLinear;break;case x:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",e),this}return this.createInterpolant=e,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return f;case this.InterpolantFactoryMethodLinear:return g;case this.InterpolantFactoryMethodSmooth:return x}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let s=0,i=e.length;s!==i;++s)e[s]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let s=0,i=e.length;s!==i;++s)e[s]*=t}return this}trim(t,e){const s=this.times,i=s.length;let r=0,n=i-1;for(;r!==i&&s[r]<t;)++r;for(;-1!==n&&s[n]>e;)--n;if(++n,0!==r||n!==i){r>=n&&(n=Math.max(n,1),r=n-1);const t=this.getValueSize();this.times=s.slice(r,n),this.values=this.values.slice(r*t,n*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);const s=this.times,i=this.values,r=s.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);let n=null;for(let e=0;e!==r;e++){const i=s[e];if("number"==typeof i&&isNaN(i)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,e,i),t=!1;break}if(null!==n&&n>i){console.error("THREE.KeyframeTrack: Out of order keys.",this,e,i,n),t=!1;break}n=i}if(void 0!==i&&(a=i,ArrayBuffer.isView(a)&&!(a instanceof DataView)))for(let e=0,s=i.length;e!==s;++e){const s=i[e];if(isNaN(s)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,e,s),t=!1;break}}var a;return t}optimize(){const t=this.times.slice(),e=this.values.slice(),s=this.getValueSize(),i=this.getInterpolation()===x,r=t.length-1;let n=1;for(let a=1;a<r;++a){let r=!1;const o=t[a];if(o!==t[a+1]&&(1!==a||o!==t[0]))if(i)r=!0;else{const t=a*s,i=t-s,n=t+s;for(let a=0;a!==s;++a){const s=e[t+a];if(s!==e[i+a]||s!==e[n+a]){r=!0;break}}}if(r){if(a!==n){t[n]=t[a];const i=a*s,r=n*s;for(let t=0;t!==s;++t)e[r+t]=e[i+t]}++n}}if(r>0){t[n]=t[r];for(let t=r*s,i=n*s,a=0;a!==s;++a)e[i+a]=e[t+a];++n}return n!==t.length?(this.times=t.slice(0,n),this.values=e.slice(0,n*s)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),s=new(0,this.constructor)(this.name,t,e);return s.createInterpolant=this.createInterpolant,s}}Jt.prototype.TimeBufferType=Float32Array,Jt.prototype.ValueBufferType=Float32Array,Jt.prototype.DefaultInterpolation=g;class Gt extends Jt{constructor(t,e,s){super(t,e,s)}}Gt.prototype.ValueTypeName="bool",Gt.prototype.ValueBufferType=Array,Gt.prototype.DefaultInterpolation=f,Gt.prototype.InterpolantFactoryMethodLinear=void 0,Gt.prototype.InterpolantFactoryMethodSmooth=void 0;(class extends Jt{}).prototype.ValueTypeName="color";(class extends Jt{}).prototype.ValueTypeName="number";class Qt extends Zt{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=(s-e)/(i-e);let h=t*a;for(let t=h+a;h!==t;h+=4)Y.slerpFlat(r,0,n,h-a,n,h,o);return r}}class Kt extends Jt{InterpolantFactoryMethodLinear(t){return new Qt(this.times,this.values,this.getValueSize(),t)}}Kt.prototype.ValueTypeName="quaternion",Kt.prototype.InterpolantFactoryMethodSmooth=void 0;class te extends Jt{constructor(t,e,s){super(t,e,s)}}te.prototype.ValueTypeName="string",te.prototype.ValueBufferType=Array,te.prototype.DefaultInterpolation=f,te.prototype.InterpolantFactoryMethodLinear=void 0,te.prototype.InterpolantFactoryMethodSmooth=void 0;(class extends Jt{}).prototype.ValueTypeName="vector";Error;const ee="\\[\\]\\.:\\/",se=new RegExp("["+ee+"]","g"),ie="[^"+ee+"]",re="[^"+ee.replace("\\.","")+"]",ne=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",ie)+/(WCOD+)?/.source.replace("WCOD",re)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",ie)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",ie)+"$"),ae=["material","materials","bones","map"];class oe{constructor(t,e,s){this.path=e,this.parsedPath=s||oe.parseTrackName(e),this.node=oe.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(t,e,s){return t&&t.isAnimationObjectGroup?new oe.Composite(t,e,s):new oe(t,e,s)}static sanitizeNodeName(t){return t.replace(/\s/g,"_").replace(se,"")}static parseTrackName(t){const e=ne.exec(t);if(null===e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const s={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},i=s.nodeName&&s.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){const t=s.nodeName.substring(i+1);-1!==ae.indexOf(t)&&(s.nodeName=s.nodeName.substring(0,i),s.objectName=t)}if(null===s.propertyName||0===s.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return s}static findNode(t,e){if(void 0===e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const s=t.skeleton.getBoneByName(e);if(void 0!==s)return s}if(t.children){const s=function(t){for(let i=0;i<t.length;i++){const r=t[i];if(r.name===e||r.uuid===e)return r;const n=s(r.children);if(n)return n}return null},i=s(t.children);if(i)return i}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(t,e){t[e]=this.targetObject[this.propertyName]}_getValue_array(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)t[e++]=s[i]}_getValue_arrayElement(t,e){t[e]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(t,e){this.resolvedProperty.toArray(t,e)}_setValue_direct(t,e){this.targetObject[this.propertyName]=t[e]}_setValue_direct_setNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=t[e++]}_setValue_array_setNeedsUpdate(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=t[e++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(t,e){this.resolvedProperty[this.propertyIndex]=t[e]}_setValue_arrayElement_setNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(t,e){this.resolvedProperty.fromArray(t,e)}_setValue_fromArray_setNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(t,e){this.bind(),this.getValue(t,e)}_setValue_unbound(t,e){this.bind(),this.setValue(t,e)}bind(){let t=this.node;const e=this.parsedPath,s=e.objectName,i=e.propertyName;let r=e.propertyIndex;if(t||(t=oe.findNode(this.rootNode,e.nodeName),this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(s){let i=e.objectIndex;switch(s){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===i){i=e;break}break;case"map":if("map"in t){t=t.map;break}if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);t=t.material.map;break;default:if(void 0===t[s])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[s]}if(void 0!==i){if(void 0===t[i])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[i]}}const n=t[i];if(void 0===n){const s=e.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+s+"."+i+" but it wasn't found.",t)}let a=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?a=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===i){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==t.morphTargetDictionary[r]&&(r=t.morphTargetDictionary[r])}o=this.BindingType.ArrayElement,this.resolvedProperty=n,this.propertyIndex=r}else void 0!==n.fromArray&&void 0!==n.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=n):Array.isArray(n)?(o=this.BindingType.EntireArray,this.resolvedProperty=n):this.propertyName=i;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}oe.Composite=class{constructor(t,e,s){const i=s||oe.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,i)}getValue(t,e){this.bind();const s=this._targetGroup.nCachedObjects_,i=this._bindings[s];void 0!==i&&i.getValue(t,e)}setValue(t,e){const s=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=s.length;i!==r;++i)s[i].setValue(t,e)}bind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,s=t.length;e!==s;++e)t[e].bind()}unbind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,s=t.length;e!==s;++e)t[e].unbind()}},oe.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},oe.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},oe.prototype.GetterByBindingType=[oe.prototype._getValue_direct,oe.prototype._getValue_array,oe.prototype._getValue_arrayElement,oe.prototype._getValue_toArray],oe.prototype.SetterByBindingTypeAndVersioning=[[oe.prototype._setValue_direct,oe.prototype._setValue_direct_setNeedsUpdate,oe.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[oe.prototype._setValue_array,oe.prototype._setValue_array_setNeedsUpdate,oe.prototype._setValue_array_setMatrixWorldNeedsUpdate],[oe.prototype._setValue_arrayElement,oe.prototype._setValue_arrayElement_setNeedsUpdate,oe.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[oe.prototype._setValue_fromArray,oe.prototype._setValue_fromArray_setNeedsUpdate,oe.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1),"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"171"}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__="171");class he{#t;constructor(t,e,s){"number"==typeof t?this.#t=new Uint8Array(t):t instanceof ArrayBuffer?this.#t=new Uint8Array(t,e,s):this.#t=new Uint8Array(Array.from(t,(t=>t?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return this.#t.byteOffset}get byteLength(){return this.#t.byteLength}get buffer(){return this.#t.buffer}get length(){return this.#t.length}get(t){let e=this.#t[t];return"number"==typeof e?0!==e:e}set(t,e){this.#t[t]=e?1:0}fill(t){this.#t.fill(t?1:0)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}class le{_data;constructor(t,e,s,i){if(this.chars=t,"number"==typeof e)this._data=new Uint8Array(e*t);else if(e instanceof ArrayBuffer)i&&(i*=t),this._data=new Uint8Array(e,s,i);else{let s=Array.from(e);this._data=new Uint8Array(s.length*t);for(let t=0;t<s.length;t++)this.set(t,s[t])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(t){const e=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);return(new TextDecoder).decode(e).replace(/\x00/g,"")}_encode(t){return(new TextEncoder).encode(t)}set(t,e){const s=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);s.fill(0),s.set(this._encode(e))}fill(t){const e=this._encode(t);for(let t=0;t<this.length;t++)this._data.set(e,t*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}class ce{_data;constructor(t,e,s,i){if(this.chars=t,"number"==typeof e)this._data=new Int32Array(e*t);else if(e instanceof ArrayBuffer)i&&(i*=t),this._data=new Int32Array(e,s,i);else{const t=e,s=this._encode.bind(this);this._data=new Int32Array(function*(){for(let e of t){let t=s(e);yield*t}}())}}get BYTES_PER_ELEMENT(){return this._data.BYTES_PER_ELEMENT*this.chars}get byteLength(){return this._data.byteLength}get byteOffset(){return this._data.byteOffset}get buffer(){return this._data.buffer}get length(){return this._data.length/this.chars}_encode(t){let e=new Int32Array(this.chars);for(let s=0;s<this.chars;s++)e[s]=t.codePointAt(s)??0;return e}get(t){const e=this.chars*t;let s="";for(let t=0;t<this.chars;t++)s+=String.fromCodePoint(this._data[e+t]);return s.replace(/\u0000/g,"")}set(t,e){const s=this.chars*t,i=this._data.subarray(s,s+this.chars);i.fill(0),i.set(this._encode(e))}fill(t){const e=this._encode(t);for(let t=0;t<this.length;t++)this._data.set(e,t*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}function ue(t){const e=(new TextDecoder).decode(t);return JSON.parse(e)}function de(t,e){const s=e/2,i=e-1;let r=0;for(let n=0;n<t.length;n+=e)for(let e=0;e<s;e+=1)r=t[n+e],t[n+e]=t[n+i-e],t[n+i-e]=r}const me={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float32:Float32Array,float64:Float64Array,bool:he},pe=/v2:([US])(\d+)/;function ye(t){if("v2:object"===t)return globalThis.Array;let e=t.match(pe);if(e){let[,t,s]=e;return("U"===t?ce:le).bind(null,Number(s))}let s=me[t];if(!s)throw new Error(`Unknown or unsupported data_type: ${t}`);return s}function fe(t,e){return("C"===e?ge:xe)(t)}function ge(t){const e=t.length,s=globalThis.Array(e);for(let i=e-1,r=1;i>=0;i--)s[i]=r,r*=t[i];return s}function xe(t){const e=t.length,s=globalThis.Array(e);for(let i=0,r=1;i<e;i++)s[i]=r,r*=t[i];return s}function _e({name:t,configuration:e}){if("default"===t)return t=>["c",...t].join(e.separator);if("v2"===t)return t=>t.join(e.separator)||"0";throw new Error(`Unknown chunk key encoding: ${t}`)}function be(t){const e=t.find((t=>"transpose"===t.name));return"F"===e?.configuration?.order?"F":"C"}const we=/^([<|>])(.*)$/;function Me(t){return"sharding_indexed"===t?.name}function ve(t){return"uint64"!==t.data_type&&"int64"!==t.data_type||null==t.fill_value?t.fill_value:BigInt(t.fill_value)}function ze(t){return t instanceof he||t instanceof le||t instanceof ce?new Proxy(t,{get:(t,e)=>t.get(Number(e)),set:(t,e,s)=>(t.set(Number(e),s),!0)}):t}Symbol("v2");class Se{configuration;kind="array_to_array";constructor(t){this.configuration=t}static fromConfig(t){return new Se(t)}encode(t){return function(t){if(!t.stride)return"C";let e=fe(t.shape,"C");return t.stride.every(((t,s)=>t===e[s]))?"C":"F"}(t)===this.configuration.order?t:function(t,e){let s=function(t,e){let s;return s=t.data instanceof le||t.data instanceof ce?new t.constructor(t.data.length,t.data.chars):new t.constructor(t.data.length),{data:s,shape:t.shape,stride:fe(t.shape,e)}}(t,e),i=t.shape.length,r=t.data.length,n=Array(i).fill(0),a=ze(t.data),o=ze(s.data);for(let e=0;e<r;e++){let r=0;for(let t=0;t<i;t++)r+=n[t]*s.stride[t];o[r]=a[e],n[0]+=1;for(let e=0;e<i;e++)if(n[e]===t.shape[e]){if(e+1===i)break;n[e]=0,n[e+1]+=1}}return s}(t,this.configuration.order)}decode(t){return t}}const Ae=function(){const t=new Uint32Array([305419896]);return!(18===new Uint8Array(t.buffer,t.byteOffset,t.byteLength)[0])}();function Ee(t){return"BYTES_PER_ELEMENT"in t?t.BYTES_PER_ELEMENT:4}class Te{configuration;kind="array_to_bytes";#e;#s;#i;#r;constructor(t,e){this.configuration=t,this.#s=ye(e.data_type),this.#r=e.shape,this.#e=fe(e.shape,be(e.codecs)),this.#i=new this.#s(0).BYTES_PER_ELEMENT}static fromConfig(t,e){return new Te(t,e)}encode(t){let e=new Uint8Array(t.data.buffer);return Ae&&"big"===this.configuration.endian&&de(e,Ee(this.#s)),e}decode(t){return Ae&&"big"===this.configuration.endian&&de(t,Ee(this.#s)),{data:new this.#s(t.buffer,t.byteOffset,t.byteLength/this.#i),shape:this.#r,stride:this.#e}}}class Ce{kind="bytes_to_bytes";constructor(){}static fromConfig(){return new Ce}encode(t){throw new Error("Not implemented")}decode(t){return new Uint8Array(t.buffer,t.byteOffset,t.byteLength-4)}}class Ie{kind="array_to_bytes";#r;#e;constructor(t){this.#r=t,this.#e=fe(t,"C")}static fromConfig(t,e){return new Ie(e.shape)}encode(t){throw new Error("Method not implemented.")}decode(t){let e=new TextDecoder,s=new DataView(t.buffer),i=Array(s.getUint32(0,!0)),r=4;for(let n=0;n<i.length;n++){let a=s.getUint32(r,!0);r+=4,i[n]=e.decode(t.buffer.slice(r,r+a)),r+=a}return{data:i,shape:this.#r,stride:this.#e}}}const ke=(new Map).set("blosc",(()=>s.e(646).then(s.bind(s,5646)).then((t=>t.default)))).set("gzip",(()=>Promise.all([s.e(56),s.e(175)]).then(s.bind(s,9175)).then((t=>t.default)))).set("lz4",(()=>s.e(985).then(s.bind(s,8985)).then((t=>t.default)))).set("zlib",(()=>Promise.all([s.e(56),s.e(954)]).then(s.bind(s,6954)).then((t=>t.default)))).set("zstd",(()=>s.e(632).then(s.bind(s,5632)).then((t=>t.default)))).set("transpose",(()=>Se)).set("endian",(()=>Te)).set("crc32c",(()=>Ce)).set("vlen-utf8",(()=>Ie));function De(t){let e;return{async encode(s){e||(e=await Ne(t));for(const t of e.array_to_array)s=await t.encode(s);let i=await e.array_to_bytes.encode(s);for(const t of e.bytes_to_bytes)i=await t.encode(i);return i},async decode(s){e||(e=await Ne(t));for(let t=e.bytes_to_bytes.length-1;t>=0;t--)s=await e.bytes_to_bytes[t].decode(s);let i=await e.array_to_bytes.decode(s);for(let t=e.array_to_array.length-1;t>=0;t--)i=await e.array_to_array[t].decode(i);return i}}}async function Ne(t){let e=t.codecs.map((async t=>{let e=await(ke.get(t.name)?.());if(!e)throw new Error(`Unknown codec: ${t.name}`);return{Codec:e,meta:t}})),s=[],i=Te.fromConfig({endian:"little"},t),r=[];for await(let{Codec:n,meta:a}of e){let e=n.fromConfig(a.configuration,t);switch(e.kind){case"array_to_array":s.push(e);break;case"array_to_bytes":i=e;break;default:r.push(e)}}return{array_to_array:s,array_to_bytes:i,bytes_to_bytes:r}}const Le=18446744073709551615n;function Oe(t,e,s,i){if(void 0===t.store.getRange)throw new Error("Store does not support range requests");let r=t.store.getRange.bind(t.store),n=e.map(((t,e)=>t/i.chunk_shape[e])),a=De({data_type:"uint64",shape:[...n,2],codecs:i.index_codecs}),o={};return async e=>{let i,h=e.map(((t,e)=>Math.floor(t/n[e]))),l=t.resolve(s(h)).path;if(l in o)i=o[l];else{let t=4,e=16*n.reduce(((t,e)=>t*e),1),s=await r(l,{suffixLength:e+t});i=o[l]=s?await a.decode(s):null}if(null===i)return;let{data:c,shape:u,stride:d}=i,m=e.map(((t,e)=>t%u[e])).reduce(((t,e,s)=>t+e*d[s]),0),p=c[m],y=c[m+1];return p!==Le||y!==Le?r(l,{offset:Number(p),length:Number(y)}):void 0}}class Re{store;path;constructor(t,e="/"){this.store=t,this.path=e}resolve(t){let e=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new Re(this.store,new URL(t,e).pathname)}}class Pe extends Re{kind="group";#n;constructor(t,e,s){super(t,e),this.#n=s}get attrs(){return this.#n.attributes}}const Ue=Symbol("zarrita.context");class Fe extends Re{kind="array";#n;[Ue];constructor(t,e,s){super(t,e),this.#n={...s,fill_value:ve(s)},this[Ue]=function(t,e){let{configuration:s}=e.codecs.find(Me)??{},i={encode_chunk_key:_e(e.chunk_key_encoding),TypedArray:ye(e.data_type),fill_value:e.fill_value};if(s){let r=be(s.codecs);return{...i,kind:"sharded",chunk_shape:s.chunk_shape,codec:De({data_type:e.data_type,shape:s.chunk_shape,codecs:s.codecs}),get_strides:(t,e)=>fe(t,e??r),get_chunk_bytes:Oe(t,e.chunk_grid.configuration.chunk_shape,i.encode_chunk_key,s)}}let r=be(e.codecs);return{...i,kind:"regular",chunk_shape:e.chunk_grid.configuration.chunk_shape,codec:De({data_type:e.data_type,shape:e.chunk_grid.configuration.chunk_shape,codecs:e.codecs}),get_strides:(t,e)=>fe(t,e??r),async get_chunk_bytes(e,s){let r=i.encode_chunk_key(e),n=t.resolve(r).path;return t.store.get(n,s)}}}(this,s)}get attrs(){return this.#n.attributes}get shape(){return this.#n.shape}get chunks(){return this[Ue].chunk_shape}get dtype(){return this.#n.data_type}async getChunk(t,e){let s=this[Ue],i=await s.get_chunk_bytes(t,e);if(!i){let t=s.chunk_shape.reduce(((t,e)=>t*e),1),e=new s.TypedArray(t);return e.fill(s.fill_value),{data:e,shape:s.chunk_shape,stride:s.get_strides(s.chunk_shape)}}return s.codec.decode(i)}is(t){return function(t,e){if("number"!==e&&"bigint"!==e&&"boolean"!==e&&"object"!==e&&"string"!==e)return t===e;let s="bool"===t;if("boolean"===e)return s;let i=t.startsWith("v2:U")||t.startsWith("v2:S");if("string"===e)return i;let r="int64"===t||"uint64"===t;if("bigint"===e)return r;let n="v2:object"===t;return"object"===e?n:!(i||r||s||n)}(this.dtype,t)}}var qe=s(9698);async function Ve(t,e={}){let s="store"in t?t:new Re(t),i={};return(e.attrs??1)&&(i=await async function(t){let e=await t.store.get(t.resolve(".zattrs").path);return e?ue(e):{}}(s)),"array"===e.kind?Be(s,i):"group"===e.kind?je(s,i):Be(s,i).catch((t=>{if(t instanceof qe._)return je(s,i);throw t}))}async function Be(t,e){let{path:s}=t.resolve(".zarray"),i=await t.store.get(s);if(!i)throw new qe._(s);return new Fe(t.store,t.path,function(t,e={}){let s=[],i=function(t){if("|O"===t)return{data_type:"v2:object"};let e=t.match(we);if(!e)throw new Error(`Invalid dtype: ${t}`);let[,s,i]=e,r={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f4:"float32",f8:"float64"}[i]??(i.startsWith("S")||i.startsWith("U")?`v2:${i}`:void 0);if(!r)throw new Error(`Unsupported or unknown dtype: ${t}`);return"|"===s?{data_type:r}:{data_type:r,endian:"<"===s?"little":"big"}}(t.dtype);"F"===t.order&&s.push({name:"transpose",configuration:{order:"F"}}),"endian"in i&&"big"===i.endian&&s.push({name:"endian",configuration:{endian:"big"}});for(let{id:e,...i}of t.filters??[])s.push({name:e,configuration:i});if(t.compressor){let{id:e,...i}=t.compressor;s.push({name:e,configuration:i})}return{zarr_format:3,node_type:"array",shape:t.shape,data_type:i.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:t.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:t.dimension_separator??"."}},codecs:s,fill_value:t.fill_value,attributes:e}}(ue(i),e))}async function je(t,e){let{path:s}=t.resolve(".zgroup"),i=await t.store.get(s);if(!i)throw new qe._(s);return new Pe(t.store,t.path,function(t,e={}){return{zarr_format:3,node_type:"group",attributes:e}}(ue(i),e))}async function We(t,e={}){let s="store"in t?t:new Re(t),i=await async function(t){let{store:e,path:s}=t.resolve("zarr.json"),i=await t.store.get(s);if(!i)throw new qe._(s);let r=ue(i);return"array"!==r.node_type||"uint64"!==r.data_type&&"int64"!==r.data_type||null==r.fill_value||(r.fill_value=BigInt(r.fill_value)),"array"===r.node_type?new Fe(e,t.path,r):new Pe(e,t.path,r)}(s);if(void 0===e.kind)return i;if("array"===e.kind&&i instanceof Fe)return i;if("group"===e.kind&&i instanceof Pe)return i;let r=i instanceof Fe?"array":"group";throw new Error(`Expected node of kind ${e.kind}, found ${r}.`)}async function Ye(t,e={}){return We(t,e).catch((s=>{if(s instanceof qe._)return Ve(t,e);throw s}))}function Ze(t,e,s=null){return void 0===e&&(e=t,t=null),{start:t,stop:e,step:s,indices(t){return function(t,e,s,i){if(0===s)throw new Error("slice step cannot be zero");const r=(s=s??1)<0,[n,a]=r?[-1,i-1]:[0,i];return null===t?t=r?a:n:t<0?(t+=i)<n&&(t=n):t>a&&(t=a),null===e?e=r?n:a:e<0?(e+=i)<n&&(e=n):e>a&&(e=a),[t,e,s]}(this.start,this.stop,this.step,t)}}}Ye.v2=Ve,Ye.v3=We;class He extends Error{constructor(t){super(t),this.name="IndexError"}}class Xe{dim_sel;dim_len;dim_chunk_len;nitems;constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){t=function(t,e){return(t=Math.trunc(t))<0&&(t=e+t),(t>=e||t<0)&&function(t){throw new He(`index out of bounds for dimension with length ${t}`)}(e),t}(t,e),this.dim_sel=t,this.dim_len=e,this.dim_chunk_len=s,this.nitems=1}*[Symbol.iterator](){const t=Math.floor(this.dim_sel/this.dim_chunk_len),e=t*this.dim_chunk_len,s=this.dim_sel-e;yield{dim_chunk_ix:t,dim_chunk_sel:s}}}class $e{start;stop;step;dim_len;dim_chunk_len;nitems;nchunks;constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){const[i,r,n]=t.indices(e);this.start=i,this.stop=r,this.step=n,this.step<1&&function(){throw new He("only slices with step >= 1 are supported")}(),this.dim_len=e,this.dim_chunk_len=s,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const t=Math.floor(this.start/this.dim_chunk_len),e=Math.ceil(this.stop/this.dim_chunk_len);for(const s of function*(t,e,s=1){void 0===e&&(e=t,t=0);for(let i=t;i<e;i+=s)yield i}(t,e)){const t=s*this.dim_chunk_len,e=Math.min(this.dim_len,(s+1)*this.dim_chunk_len),i=e-t;let r=0,n=0;if(this.start<t){const e=(t-this.start)%this.step;e&&(n+=this.step-e),r=Math.ceil((t-this.start)/this.step)}else n=this.start-t;const a=this.stop>e?i:this.stop-t,o=[n,a,this.step],h=[r,r+Math.ceil((a-n)/this.step),1];yield{dim_chunk_ix:s,dim_chunk_sel:o,dim_out_sel:h}}}}class Je{dim_indexers;shape;constructor({selection:t,shape:e,chunk_shape:s}){this.dim_indexers=function(t,e){let s=[];return null===t?s=e.map((t=>Ze(null))):Array.isArray(t)&&(s=t.map((t=>t??Ze(null)))),function(t,e){t.length>e.length&&function(t,e){throw new He(`too many indicies for array; expected ${e.length}, got ${t.length}`)}(t,e)}(s,e),s}(t,e).map(((t,i)=>new("number"==typeof t?Xe:$e)({dim_sel:t,dim_len:e[i],dim_chunk_len:s[i]}))),this.shape=this.dim_indexers.filter((t=>t instanceof $e)).map((t=>t.nitems))}*[Symbol.iterator](){for(const t of function*(...t){if(0===t.length)return;const e=t.map((t=>t[Symbol.iterator]())),s=e.map((t=>t.next()));if(s.some((t=>t.done)))throw new Error("Input contains an empty iterator.");for(let i=0;;){if(s[i].done){if(e[i]=t[i][Symbol.iterator](),s[i]=e[i].next(),++i>=e.length)return}else yield s.map((({value:t})=>t)),i=0;s[i]=e[i].next()}}(...this.dim_indexers)){const e=t.map((t=>t.dim_chunk_ix)),s=t.map((t=>"dim_out_sel"in t?{from:t.dim_chunk_sel,to:t.dim_out_sel}:{from:t.dim_chunk_sel,to:null}));yield{chunk_coords:e,mapping:s}}}}function Ge(t,e=0,s){let i=s??t.length-e;return new Proxy(t,{get(t,s){let r=+s;return Number.isNaN(r)?"subarray"===s?(s,r=i)=>Ge(t,e+s,r-s):"set"===s?(s,i)=>{for(let r=0;r<s.length;r++)t[e+i+r]=s[r]}:Reflect.get(t,s):t[e+r]},set:(t,s,i)=>(t[e+Number(s)]=i,!0)})}function Qe(t){const e=t.constructor.bind(null,t.chars);return new Proxy(t,{get(s,i){let r=+i;return Number.isNaN(r)?"subarray"===i?(i,r=t.length)=>Qe(new e(s.buffer,s.byteOffset+t.BYTES_PER_ELEMENT*i,r-i)):"set"===i?(t,e)=>{for(let i=0;i<t.length;i++)s.set(e+i,t.get(i))}:"fill"===i?(t,e,i)=>{for(let r=e;r<i;r++)s.set(r,t)}:Reflect.get(s,i):s.get(r)},set:(t,e,s)=>(t.set(Number(e),s),!0)})}function Ke(t){let e=t.data;return t.data instanceof he?e=new Uint8Array(t.data.buffer):t.data instanceof le||t.data instanceof ce?e=Qe(t.data):t.data instanceof globalThis.Array&&(e=Ge(t.data)),{data:e,stride:t.stride}}const ts={prepare:(t,e,s)=>({data:t,shape:e,stride:s}),set_scalar(t,e,s){ss(Ke(t),e,function(t,e){return t.data instanceof he?e?1:0:e}(t,s))},set_from_chunk(t,e,s){is(Ke(t),Ke(e),s)}};function es(t,e,s){return s<0&&e<t?Math.floor((t-e-1)/-s)+1:t<e?Math.floor((e-t-1)/s)+1:0}function ss(t,e,s){if(0===e.length)return void(t.data[0]=s);const[i,...r]=e,[n,...a]=t.stride;if("number"==typeof i)return void ss({data:t.data.subarray(n*i),stride:a},r,s);const[o,h,l]=i,c=es(o,h,l);if(0!==r.length)for(let e=0;e<c;e++)ss({data:t.data.subarray(n*(o+l*e)),stride:a},r,s);else if(1===l&&1===n)t.data.fill(s,o,o+c);else for(let e=0;e<c;e++)t.data[n*(o+l*e)]=s}function is(t,e,s){const[i,...r]=s,[n,...a]=t.stride,[o,...h]=e.stride;if(null===i.from)return 0===r.length?void(t.data[i.to]=e.data[0]):void is({data:t.data.subarray(n*i.to),stride:a},e,r);if(null===i.to)return 0===r.length?void(t.data[0]=e.data[i.from]):void is(t,{data:e.data.subarray(o*i.from),stride:h},r);const[l,c,u]=i.to,[d,m,p]=i.from,y=es(l,c,u);if(0!==r.length)for(let s=0;s<y;s++)is({data:t.data.subarray(n*(l+s*u)),stride:a},{data:e.data.subarray(o*(d+s*p)),stride:h},r);else if(1===u&&1===p&&1===n&&1===o)t.data.set(e.data.subarray(d,d+y),l);else for(let s=0;s<y;s++)t.data[n*(l+u*s)]=e.data[o*(d+p*s)]}function rs(t,e,s,i={}){return void 0!==e&&void 0!==s&&(i={...i,headers:{...i.headers,Range:`bytes=${e}-${e+s-1}`}}),fetch(t,i)}function ns(t,e){const s="string"==typeof t?new URL(t):t;s.pathname.endsWith("/")||(s.pathname+="/");const i=new URL(e.slice(1),s);return i.search=s.search,i}async function as(t){if(404!==t.status&&403!==t.status){if(200==t.status||206==t.status)return new Uint8Array(await t.arrayBuffer());throw new Error(`Unexpected response status ${t.status} ${t.statusText}`)}}const os=class{url;#a;#o;constructor(t,e={}){this.url=t,this.#a=e.overrides??{},this.#o=e.useSuffixRequest??!1}#h(t){return{...this.#a,...t,headers:{...this.#a.headers,...t.headers}}}async get(t,e={}){let s=ns(this.url,t).href;return as(await fetch(s,this.#h(e)))}async getRange(t,e,s={}){let i,r=ns(this.url,t),n=this.#h(s);return i="suffixLength"in e?await async function(t,e,s,i){if(i)return fetch(t,{...s,headers:{...s.headers,Range:`bytes=-${e}`}});let r=await fetch(t,{...s,method:"HEAD"});if(!r.ok)return r;let n=r.headers.get("Content-Length"),a=Number(n);return rs(t,a-e,a,s)}(r,e.suffixLength,n,this.#o):await rs(r,e.offset,e.length,n),as(i)}},hs="request cancelled";class ls{constructor(t=10,e=5){this.allRequests=new Map,this.activeRequests=new Set,this.queue=[],this.queueLowPriority=[],this.maxActiveRequests=t,this.maxLowPriorityRequests=Math.min(t,e)}registerRequest(t,e){let s,i;const r=new Promise(((t,e)=>{s=t,i=e})),n={key:t,action:e,resolve:s,reject:i,promise:r};return this.allRequests.set(t,n),n}addRequestToQueue(t,e){if(this.allRequests.has(t)){const s=this.allRequests.get(t);s&&s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=void 0),this.queue.includes(t)||this.queueLowPriority.includes(t)||(e?this.queueLowPriority.push(t):this.queue.push(t),this.dequeue())}}addRequest(t,e,s=!1,i=0){if(this.allRequests.has(t)){const e=this.queueLowPriority.indexOf(t);e>-1&&!s?(this.queueLowPriority.splice(e,1),this.addRequestToQueue(t)):i<=0&&this.addRequestToQueue(t,s)}else{const r=this.registerRequest(t,e);if(i>0){const e=setTimeout((()=>this.addRequestToQueue(t,s)),i);r.timeoutId=e}else this.addRequestToQueue(t,s)}const r=this.allRequests.get(t)?.promise;if(!r)throw new Error("Found no promise to return when getting stored request data.");return r}addRequests(t,e=!1,s=10){const i=[];for(let r=0;r<t.length;r++){const n=t[r],a=this.addRequest(n.key,n.requestAction,e,s*r);i.push(a)}return i}async dequeue(){const t=this.activeRequests.size;if(t>=this.maxActiveRequests||0===this.queue.length&&(t>=this.maxLowPriorityRequests||0===this.queueLowPriority.length))return;const e=this.queue.shift()??this.queueLowPriority.shift();if(!e)return;if(this.activeRequests.has(e))return void this.dequeue();const s=this.allRequests.get(e);if(!s)return;const i=s.key;this.activeRequests.add(i),await s.action().then(s.resolve,s.reject),this.activeRequests.delete(i),this.allRequests.delete(i),this.dequeue()}cancelRequest(t,e=hs){if(!this.allRequests.has(t))return;const s=this.allRequests.get(t);s&&(s.timeoutId&&clearTimeout(s.timeoutId),s.reject(e));const i=this.queue.indexOf(t);if(i>-1)this.queue.splice(i,1);else{const e=this.queueLowPriority.indexOf(t);e>-1&&this.queueLowPriority.splice(e,1)}this.allRequests.delete(t),this.activeRequests.delete(t)}cancelAllRequests(t=hs){this.queue=[],this.queueLowPriority=[];for(const e of this.allRequests.keys())this.cancelRequest(e,t)}hasRequest(t){return this.allRequests.has(t)}requestRunning(t){return this.activeRequests.has(t)}}class cs{constructor(t,e){this.queue="number"==typeof t||void 0===t?new ls(t,e):t,this.nextSubscriberId=0,this.subscribers=new Map,this.requests=new Map}resolveAll(t,e){const s=this.requests.get(t);if(s){for(const{resolve:i,subscriberId:r}of s)i(e),this.subscribers.get(r)?.delete(t);this.requests.delete(t)}}rejectAll(t,e){const s=this.requests.get(t);if(s){for(const{reject:i,subscriberId:r}of s)i(e),this.subscribers.get(r)?.delete(t);this.requests.delete(t)}}addSubscriber(){const t=this.nextSubscriberId;return this.nextSubscriberId++,this.subscribers.set(t,new Map),t}addRequest(t,e,s,i,r){if(this.queue.addRequest(t,s,i,r).then((e=>this.resolveAll(t,e))).catch((e=>this.rejectAll(t,e))),this.requests.has(t)||this.requests.set(t,[]),e>=this.nextSubscriberId||e<0)throw new Error(`SubscribableRequestQueue: subscriber id ${e} has not been registered`);if(!this.subscribers.get(e))throw new Error(`SubscribableRequestQueue: subscriber id ${e} has been removed`);return new Promise(((s,i)=>{this.requests.get(t)?.push({resolve:s,reject:i,subscriberId:e});const r=this.subscribers.get(e),n=r?.get(t);n?n.push(i):r?.set(t,[i])}))}rejectSubscription(t,e,s){e(s);const i=this.requests.get(t);if(!i)return;const r=i.findIndex((t=>t.reject===e));r>=0&&i.splice(r,1),i.length<1&&!this.queue.requestRunning(t)&&(this.queue.cancelRequest(t,s),this.requests.delete(t))}cancelRequest(t,e,s){const i=this.subscribers.get(e);if(!i)return!1;const r=i.get(t);if(!r||!r.length)return!1;for(const e of r)this.rejectSubscription(t,e,s);return i.delete(t),!0}removeSubscriber(t,e){const s=this.subscribers.get(t);if(s){for(const[t,i]of s.entries())for(const s of i)this.rejectSubscription(t,s,e);this.subscribers.delete(t)}}hasRequest(t){return this.queue.hasRequest(t)}requestRunning(t){return this.queue.requestRunning(t)}hasSubscriber(t){return this.subscribers.has(t)}isSubscribed(t,e){return this.subscribers.get(t)?.has(e)??!1}}class us{constructor(t){this.dataMinBin=0,this.dataMaxBin=0,this.maxBin=0,this.bins=new Uint32Array,this.min=0,this.max=0,this.binSize=0;const e=us.calculateHistogram(t,256);this.bins=e.bins,this.min=e.min,this.max=e.max,this.binSize=e.binSize;for(let t=0;t<this.bins.length;t++)if(this.bins[t]>0){this.dataMinBin=t;break}for(let t=this.bins.length-1;t>=0;t--)if(this.bins[t]>0){this.dataMaxBin=t;break}this.pixelCount=t.length,this.maxBin=1;let s=this.bins[1];for(let t=1;t<this.bins.length;t++)this.bins[t]>s&&(this.maxBin=t,s=this.bins[t])}static findBin(t,e,s,i){let r=Math.floor((t-e)/s);return r===i&&r--,r}findBinOfValue(t){return us.findBin(t,this.min,this.binSize,256)}getDataMin(){return this.min}getDataMax(){return this.max}getMin(){return this.dataMinBin}getMax(){return this.dataMaxBin}getNumBins(){return this.bins.length}getBin(t){return this.bins[t]}getBinRange(t){return[this.min+t*this.binSize,this.min+(t+1)*this.binSize]}findBinOfPercentile(t){const e=this.pixelCount*t;let s=0,i=0;for(s=0;s<this.bins.length&&(i+=this.bins[s],!(i>e));++s);return s}findBestFitBins(){const t=this.pixelCount/10;let e=0,s=0;for(e=1;e<this.bins.length&&(s+=this.bins[e],!(s>t));++e);const i=e;for(s=0,e=this.bins.length-1;e>=1&&(s+=this.bins[e],!(s>t));--e);return[i,e]}findAutoIJBins(){const t=this.pixelCount,e=t/10,s=t/5e3;let i=this.bins.length-1,r=1;for(let t=1;t<this.bins.length;++t)if(this.bins[t]>s&&this.bins[t]<=e){i=t;break}for(let t=this.bins.length-1;t>=1;--t)if(this.bins[t]>s&&this.bins[t]<=e){r=t;break}return r<i&&(i=0,r=255),[i,r]}findAutoMinMax(){const t=Math.floor(.1*this.bins[this.maxBin]);let e=0,s=this.bins.length-1;for(let s=1;s<this.bins.length;++s)if(this.bins[s]>t){e=s;break}for(let e=this.bins.length-1;e>=1;--e)if(this.bins[e]>t){s=e;break}return[e,s]}static calculateHistogram(t,e=1){e<1&&(e=1);let s=t[0],i=t[0];for(let e=1;e<t.length;e++)t[e]<s?s=t[e]:t[e]>i&&(i=t[e]);const r=new Uint32Array(e).fill(0),n=(i-s)/e==0?1:(i-s)/e;for(let i=0;i<t.length;i++){const a=t[i];r[us.findBin(a,s,n,e)]++}return{bins:r,min:s,max:i,binSize:n}}}const ds=[[255,0,255],[255,255,255],[0,255,255]],ms=(ps=123,function(){return(2147483647&(ps=0|Math.imul(48271,ps)))/2147483648});var ps;const ys=t=>(ds[t]||(ds[t]=function(t,e,s){let i,r,n,a=0;if(1===arguments.length){const i=t;e=i.s,s=i.v,a=i.h}else a=t;const o=Math.floor(6*a),h=6*a-o,l=s*(1-e),c=s*(1-h*e),u=s*(1-(1-h)*e);switch(o%6){case 0:i=s,r=u,n=l;break;case 1:i=c,r=s,n=l;break;case 2:i=l,r=s,n=u;break;case 3:i=l,r=c,n=s;break;case 4:i=u,r=l,n=s;break;case 5:i=s,r=l,n=c}return[Math.round(255*i),Math.round(255*r),Math.round(255*n)]}(ms(),.5*ms()+.5,.5*ms()+.5)),ds[t]);function fs(t,e,s){return Math.min(Math.max(e,t),s)}function gs(t,e,s){return s*(e-t)+t}function xs(t,e,s,i,r,n,a){return e+((t-e)/(s-e)*(a-n)+n-i)/(r-i)*(s-e)}function _s(t,e,s,i,r,n,a){return e+((t-e)/(s-e)*(r-i)+i-n)/(a-n)*(s-e)}const bs=256,ws=1024;function Ms(t){return[t.color[0],t.color[1],t.color[2],Math.floor(255*t.opacity)]}const vs=(t=0,e=1)=>[{x:0,opacity:t,color:[255,255,255]},{x:255,opacity:e,color:[255,255,255]}];class zs{constructor(){this.lut=new Uint8Array(ws),this.controlPoints=[],this.createFullRange()}createFromMinMax(t,e){if(e<t){const s=e;e=t,t=s}if(t<0&&e<0)return this.controlPoints=vs(1,1),this.createFromControlPoints(this.controlPoints);if(t>=255&&e>=255)return this.controlPoints=vs(0,0),this.createFromControlPoints(this.controlPoints);const s=[];let i=0;t<0&&(i=-t/(e-t)),s.push({x:0,opacity:i,color:[255,255,255]}),t>0&&s.push({x:t,opacity:0,color:[255,255,255]}),e<255&&(e===t?s.push({x:t+.5,opacity:1,color:[255,255,255]}):s.push({x:e,opacity:1,color:[255,255,255]}));let r=1;return e>255&&(r=(255-t)/(e-t)),s.push({x:255,opacity:r,color:[255,255,255]}),this.createFromControlPoints(s)}createFullRange(){return this.controlPoints=vs(),this.createFromControlPoints(this.controlPoints)}createFromWindowLevel(t,e){const s=e-.5*t,i=e+.5*t;return this.createFromMinMax(255*s,255*i)}createFromControlPoints(t){return this.lut=function(t){const e=new Uint8Array(1024).fill(0);if(0===t.length)return e;if(t.sort(((t,e)=>t.x-e.x)),1===t.length){const s=Ms(t[0]);for(let i=fs(t[0].x,0,255);i<256;++i)e[4*i+0]=s[0],e[4*i+1]=s[1],e[4*i+2]=s[2],e[4*i+3]=s[3];return e}let s=t[0],i=t[1],r=Ms(s),n=Ms(i),a=1,o=0;for(let h=0;h<256;++h){for(;h>i.x;)s=i,r=n,a++,i=a>=t.length?{x:255,color:i.color,opacity:i.opacity}:t[a],n=Ms(i);o=i.x===s.x?1:(h-s.x)/(i.x-s.x),e[4*h+0]=fs(gs(r[0],n[0],o),0,255),e[4*h+1]=fs(gs(r[1],n[1],o),0,255),e[4*h+2]=fs(gs(r[2],n[2],o),0,255),e[4*h+3]=fs(gs(r[3],n[3],o),0,255)}return e}(t),this.controlPoints=t,this}createFromEqHistogram(t){const e=[];for(let s=0;s<t.getNumBins();++s)e[s]=0;e[0]=t.getBin(0);for(let s=1;s<t.getNumBins();++s)e[s]=e[s-1]+t.getBin(s);if(e[e.length-1]-e[0]>0){const t=[{x:0,opacity:0,color:[255,255,255]}];let s=0,i=0,r=0,n=0;for(let a=1;a<bs;++a)n=r,r=fs(Math.round(255*(e[a]-e[0])),0,255),s=r-n,s!=i&&(t.push({x:a-1,opacity:n/255,color:[255,255,255]}),i=s);return t.push({x:255,opacity:1,color:[255,255,255]}),this.createFromControlPoints(t)}return this.createFullRange()}createLabelColors(t){const e=new Uint8Array(ws).fill(0),s=[];s.push({x:0,opacity:0,color:[0,0,0]});let i=0,r=0,n=0,a=0,o=0,h=0,l=0,c=0;for(let u=1;u<bs;++u){const d=Math.floor(u/255*(t.getNumBins()-1));if(t.getBin(d)>0){const t=ys(d);e[4*u+0]=t[0],e[4*u+1]=t[1],e[4*u+2]=t[2],e[4*u+3]=255,o=t[0],h=t[1],l=t[2],c=1}else o=0,h=0,l=0,c=0;o===i&&h===r&&l===n&&c===a||(0===a&&s.push({x:u-.5,opacity:a,color:[i,r,n]}),s.push({x:u,opacity:c,color:[o,h,l]}),i=o,r=h,n=l,a=c)}return this.lut=e,this.controlPoints=s,this}remapDomains(t,e,s,i){this.lut=function(t,e,s,i,r){const n=new Uint8Array(ws);for(let a=0;a<bs;++a){let o=xs(a,0,255,e,s,i,r);o<0&&(o=0),o>255&&(o=255);const h=Math.floor(o),l=Math.ceil(o),c=o-h;n[4*a+0]=Math.round(gs(t[4*h+0],t[4*l+0],c)),n[4*a+1]=Math.round(gs(t[4*h+1],t[4*l+1],c)),n[4*a+2]=Math.round(gs(t[4*h+2],t[4*l+2],c)),n[4*a+3]=Math.round(gs(t[4*h+3],t[4*l+3],c))}return n}(this.lut,t,e,s,i),this.controlPoints=function(t,e,s,i,r,n=!0){if(0===t.length)return t;const a=[],o=t[0].x,h=t[t.length-1].x;for(let n=0;n<t.length;++n){const o=t[n],h={x:_s(o.x,0,255,e,s,i,r),opacity:o.opacity,color:[o.color[0],o.color[1],o.color[2]]};a.push(h)}return n?function(t,e,s){const i=1e-4,r=t[0],n=t[1],a=t[t.length-2],o=t[t.length-1];return Math.abs(r.opacity-(n?.opacity??1/0))<i&&(r.x<0?r.x=Math.min(0,n.x-1):e<i&&(r.x=0)),Math.abs(o.opacity-(a?.opacity??1/0))<i&&(o.x>255?o.x=Math.max(255,a.x+1):s>254.9999&&(o.x=255)),t}(a,o,h):a}(this.controlPoints,t,e,s,i)}}const Ss={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float32:Float32Array,float64:Float64Array};class As{constructor(t){this.loaded=!1,this.dtype="uint8",this.imgData={data:new Uint8Array,width:0,height:0},this.rawMin=0,this.rawMax=255,this.dataTexture=new Wt(new Uint8Array,0,0),this.lutTexture=new Wt(new Uint8Array(ws),256,1,1023,p),this.lutTexture.minFilter=this.lutTexture.magFilter=1006,this.lutTexture.generateMipmaps=!1,this.volumeData=new Uint8Array,this.name=t,this.histogram=new us(new Uint8Array),this.dims=[0,0,0],this.lut=(new zs).createFromMinMax(0,255),this.colorPalette=new Uint8Array(ws).fill(0),this.colorPaletteAlpha=0}combineLuts(t,e){const s=e||new Uint8Array(ws);if(!t)return s;const i=[t[0]/255,t[1]/255,t[2]/255];if(1===this.colorPaletteAlpha)s.set(this.colorPalette);else if(0===this.colorPaletteAlpha){s.set(this.lut.lut);for(let t=0;t<256;++t)s[4*t+0]*=i[0],s[4*t+1]*=i[1],s[4*t+2]*=i[2]}else for(let t=0;t<256;++t)s[4*t+0]=this.colorPalette[4*t+0]*this.colorPaletteAlpha+this.lut.lut[4*t+0]*(1-this.colorPaletteAlpha)*i[0],s[4*t+1]=this.colorPalette[4*t+1]*this.colorPaletteAlpha+this.lut.lut[4*t+1]*(1-this.colorPaletteAlpha)*i[1],s[4*t+2]=this.colorPalette[4*t+2]*this.colorPaletteAlpha+this.lut.lut[4*t+2]*(1-this.colorPaletteAlpha)*i[2],s[4*t+3]=this.colorPalette[4*t+3]*this.colorPaletteAlpha+this.lut.lut[4*t+3]*(1-this.colorPaletteAlpha);return this.lutTexture.image.data.set(s),this.lutTexture.needsUpdate=!0,s}setRawDataRange(t,e){0===this.rawMin&&0===this.rawMax||0===t&&0===e||(this.lut.remapDomains(this.rawMin,this.rawMax,t,e),this.rawMin=t,this.rawMax=e)}getHistogram(){return this.histogram}getIntensity(t,e,s){return this.volumeData[t+e*this.dims[0]+s*(this.dims[0]*this.dims[1])]}normalizeRaw(t){return(t-this.rawMin)/(this.rawMax-this.rawMin)}getIntensityFromAtlas(t,e,s){const i=this.imgData.width/this.dims[0],r=s%i,n=Math.floor(s/i),a=r*this.dims[0]+t+(n*this.dims[1]+e)*this.imgData.width;return this.imgData.data[a]}rebuildDataTexture(t,e,s){this.dataTexture&&this.dataTexture.dispose();let i=1024,r=p,n="LUMINANCE";switch(this.dtype){case"uint8":r=p,i=y,n="R8UI";break;case"int8":r=1010,i=y,n="R8I";break;case"uint16":r=1012,i=y,n="R16UI";break;case"int16":r=1011,i=y,n="R16I";break;case"uint32":r=1014,i=y,n="R32UI";break;case"int32":r=1013,i=y,n="R32I";break;case"float32":r=1015,i=1028,n="R32F";break;default:console.warn("unsupported dtype for channel data",this.dtype)}this.dataTexture=new Wt(t,e,s,i,r,300,m,m,1003,1003),this.dataTexture.internalFormat=n,this.dataTexture.needsUpdate=!0}setFromAtlas(t,e,s,i,r,n,a){this.dtype=i,this.imgData={data:t,width:e,height:s},this.rebuildDataTexture(this.imgData.data,e,s),this.loaded=!0,this.histogram=new us(t),this.setRawDataRange(r,n),this.unpackFromAtlas(a.x,a.y,a.z)}unpackFromAtlas(t,e,s){const i=this.imgData.data;this.dims=[t,e,s];const r=Ss[this.dtype];this.volumeData=new r(t*e*s);const n=this.imgData.width/t,a=this.imgData.width;let o=0,h=0,l=0,c=0,u=0;for(let r=0;r<s;++r){o=r%n,h=Math.floor(r/n),l=o*t+h*e*a;for(let s=0;s<e;++s)c=s*a,u=r*(t*e)+s*t,this.volumeData.set(i.subarray(l+c,l+c+t),u)}}setFromVolumeData(t,e,s,i,r,n,a,o,h){this.dims=[e,s,i],this.volumeData=t,this.dtype=h,this.packToAtlas(e,s,i,r,n),this.loaded=!0,this.setRawDataRange(a,o),this.histogram=new us(this.volumeData)}packToAtlas(t,e,s,i,r){(i%t!=0||r%e!=0||i/t*(r/e)<s)&&(console.log("ERROR - atlas and volume dims are inconsistent"),console.log(i,r,t,e,s));const n=Ss[this.dtype];this.imgData={width:i,height:r,data:new n(i*r)},this.imgData.data.fill(0);const a=this.imgData.data,o=t,h=e,l=s,c=this.imgData.width/o,u=this.imgData.width;let d=0,m=0,p=0,y=0,f=0;for(let t=0;t<l;++t){d=t%c,m=Math.floor(t/c),p=d*o+m*h*u;for(let e=0;e<h;++e)y=e*u,f=t*(o*h)+e*o,a.set(this.volumeData.subarray(f,f+o),p+y)}this.rebuildDataTexture(this.imgData.data,i,r)}setLut(t){this.lut=t}setColorPalette(t){this.colorPalette=t}setColorPaletteAlpha(t){this.colorPaletteAlpha=t}}function Es(t){return new Z(t.shape[4],t.shape[3],t.shape[2])}class Ts{constructor(t){this.imageInfo=t||{name:"",atlasTileDims:[1,1],subregionSize:[1,1,1],subregionOffset:[0,0,0],combinedNumChannels:1,channelNames:["0"],channelColors:[[255,255,255]],multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,1,1,1,1],spacing:[1,1,1,1,1],spaceUnit:"",timeUnit:"",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}}}get currentLevelDims(){return this.imageInfo.multiscaleLevelDims[this.imageInfo.multiscaleLevel]}get numChannels(){return this.imageInfo.combinedNumChannels}get originalSize(){return Es(this.imageInfo.multiscaleLevelDims[0])}get volumeSize(){return Es(this.currentLevelDims)}get physicalPixelSize(){return t=this.imageInfo.multiscaleLevelDims[0],new Z(t.spacing[4],t.spacing[3],t.spacing[2]);var t}get spatialUnit(){return this.imageInfo.multiscaleLevelDims[0].spaceUnit}get times(){return this.currentLevelDims.shape[0]}get timeScale(){return this.currentLevelDims.spacing[0]}get timeUnit(){return this.currentLevelDims.timeUnit}get numMultiscaleLevels(){return this.imageInfo.multiscaleLevelDims.length}get channelNames(){return this.imageInfo.channelNames}get channelColors(){return this.imageInfo.channelColors}get subregionSize(){return new Z(...this.imageInfo.subregionSize)}get subregionOffset(){return new Z(...this.imageInfo.subregionOffset)}get multiscaleLevel(){return this.imageInfo.multiscaleLevel}get atlasTileDims(){return new T(...this.imageInfo.atlasTileDims)}get transform(){return{translation:new Z(...this.imageInfo.transform.translation),rotation:new Z(...this.imageInfo.transform.rotation),scale:new Z(...this.imageInfo.transform.scale)}}}const Cs=4096,Is={angstrom:"Å",day:"d",foot:"ft",hour:"h",inch:"in",meter:"m",micron:"μm",mile:"mi",minute:"min",parsec:"pc",second:"s",yard:"yd"},ks=["meter","second"],Ds={micro:"μ",deca:"da"};function Ns(t){if(void 0===t)return null;if(Is[t])return Is[t];const e=ks.find((e=>t.endsWith(e)));if(e){const s=t.substring(0,t.length-e.length);return Ds[s]?Ds[s]+Is[e]:(s.endsWith("a")?s[0].toUpperCase():s[0])+Is[e]}return null}function Ls(t,e,s){let i=1,r=t,n=r*e/(i*s),a=i,o=r;for(;n>1;)a=i,o=r,r-=1,i=Math.ceil(t/r),n=r*e/(i*s);return new T(a,o)}function Os(t,e=4096){const s=t[2],i=t[1],r=t[0];return Math.floor(e/s)*Math.floor(e/i)>=r}const Rs=t=>Math.max(Math.ceil(t),1);function Ps(t,e){if(t.useExplicitLevel&&void 0!==t.multiscaleLevel)return Math.max(0,Math.min(e.length-1,t.multiscaleLevel));let s=function(t,e=4096){if(t.length<=1)return 0;for(let s=0;s<t.length;++s)if(Os(t[s],e))return s}(e,t.maxAtlasEdge);if(void 0!==s&&(s=Math.max(s+(t.scaleLevelBias??0),t.multiscaleLevel??0),s=Math.max(0,Math.min(e.length-1,s)),Os(e[s],t.maxAtlasEdge)))return s;void 0===s&&(s=e.length-1);const i=e[s];return console.error(`Volume is too large; no multiscale level found that fits in preferred memory footprint. Selected level ${s}  has dimensions `,i,`. Max atlas edge allowed is ${t.maxAtlasEdge}.`),console.log("All available levels: ",e),s}function Us(t,e){return Ps(t,function(t,e){const s=t.getSize(new Z);return e.map((t=>((t,[e,s,i])=>[Rs(e*t.z),Rs(s*t.y),Rs(i*t.x)])(s,t)))}(t.subregion,e))}function Fs(t,e){const s=t.min.clone().multiply(e).floor(),i=t.max.clone().multiply(e).ceil();return s.x===i.x&&s.x<e.x&&(i.x+=1),s.y===i.y&&s.y<e.y&&(i.y+=1),s.z===i.z&&s.z<e.z&&(i.z+=1),new $(s,i)}function qs(t,e){const s=e.getSize(new Z),i=t.min.clone().multiply(s).add(e.min),r=t.max.clone().multiply(s).add(e.min);return new $(i,r)}class Vs{constructor(t={name:"",atlasTileDims:[1,1],subregionSize:[1,1,1],subregionOffset:[0,0,0],combinedNumChannels:1,channelNames:["0"],channelColors:[[255,255,255]],multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,1,1,1,1],spacing:[1,1,1,1,1],spaceUnit:"",timeUnit:"",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},e=new Bs,s){if(this.loaded=!1,this.imageInfo=new Ts(t),this.name=t.name,this.loadSpec={multiscaleLevel:0,scaleLevelBias:0,maxAtlasEdge:Cs,channels:Array.from({length:this.imageInfo.numChannels},((t,e)=>e)),...e},this.loadSpecRequired={...this.loadSpec,channels:this.loadSpec.channels.slice(),subregion:this.loadSpec.subregion.clone()},this.loader=s,this.imageMetadata={},this.normRegionSize=new Z(1,1,1),this.normRegionOffset=new Z(0,0,0),this.physicalSize=new Z(1,1,1),this.physicalScale=1,this.normPhysicalSize=new Z(1,1,1),this.physicalPixelSize=this.imageInfo.physicalPixelSize,this.tickMarkPhysicalLength=1,this.setVoxelSize(this.physicalPixelSize),this.numChannels=this.imageInfo.numChannels,this.channelNames=this.imageInfo.channelNames.slice(),this.channelColorsDefault=this.imageInfo.channelColors?this.imageInfo.channelColors.slice():this.channelNames.map(((t,e)=>ys(e))),this.channelColorsDefault.length<this.imageInfo.numChannels)for(let t=this.channelColorsDefault.length-1;t<this.imageInfo.numChannels;++t)this.channelColorsDefault[t]=ys(t);this.channels=[];for(let t=0;t<this.imageInfo.numChannels;++t){const e=new As(this.channelNames[t]);this.channels.push(e),e.dims=this.imageInfo.subregionSize.toArray()}this.physicalUnitSymbol=this.imageInfo.spatialUnit,this.volumeDataObservers=[]}setUnloaded(){this.loaded=!1,this.channels.forEach((t=>{t.loaded=!1}))}isLoaded(){return this.loaded}updateDimensions(){const{volumeSize:t,subregionSize:e,subregionOffset:s}=this.imageInfo;this.setVoxelSize(this.physicalPixelSize),this.normRegionSize=e.clone().divide(t),this.normRegionOffset=s.clone().divide(t)}mustLoadNewData(){return this.loadSpec.useExplicitLevel!==this.loadSpecRequired.useExplicitLevel||this.loadSpec.time!==this.loadSpecRequired.time||!this.loadSpec.subregion.containsBox(this.loadSpecRequired.subregion)||this.loadSpecRequired.channels.some((t=>!this.loadSpec.channels.includes(t)))}mayLoadNewScaleLevel(){return!this.loadSpec.subregion.equals(this.loadSpecRequired.subregion)||this.loadSpecRequired.maxAtlasEdge!==this.loadSpec.maxAtlasEdge||this.loadSpecRequired.multiscaleLevel!==this.loadSpec.multiscaleLevel||this.loadSpecRequired.scaleLevelBias!==this.loadSpec.scaleLevelBias}async updateRequiredData(t,e){this.loadSpecRequired={...this.loadSpecRequired,...t};let s=this.mustLoadNewData();if(!s&&this.mayLoadNewScaleLevel()){const t=await this.loadScaleLevelDims();if(t){const e=t.map((({shape:t})=>[t[2],t[3],t[4]])),i=Ps(this.loadSpecRequired,e);s=this.imageInfo.multiscaleLevel!==i}}s&&this.loadNewData(e)}async loadScaleLevelDims(){try{return await(this.loader?.loadDims(this.loadSpecRequired))}catch(t){return void this.volumeDataObservers.forEach((e=>e.onVolumeLoadError(this,t)))}}async loadNewData(t){this.setUnloaded(),this.loadSpec={...this.loadSpecRequired,subregion:this.loadSpecRequired.subregion.clone()};try{await(this.loader?.loadVolumeData(this,void 0,t))}catch(t){throw this.volumeDataObservers.forEach((e=>e.onVolumeLoadError(this,t))),t}}setVoxelSize(t){t.x=t.x>0?t.x:1,t.y=t.y>0?t.y:1,t.z=t.z>0?t.z:1,this.physicalPixelSize=t,this.physicalSize=this.imageInfo.originalSize.clone().multiply(this.physicalPixelSize),this.physicalScale=Math.max(this.physicalSize.x,this.physicalSize.y,this.physicalSize.z),this.normPhysicalSize=this.physicalSize.clone().divideScalar(this.physicalScale),this.tickMarkPhysicalLength=10**Math.floor(Math.log10(this.physicalScale/2))}setUnitSymbol(t){this.physicalUnitSymbol=t}getContentCenter(){return this.normRegionSize.clone().divideScalar(2).add(this.normRegionOffset).subScalar(.5).multiply(this.normPhysicalSize)}cleanup(){}getChannel(t){return this.channels[t]}onChannelLoaded(t){this.loadSpec.channels.every((t=>this.channels[t].loaded))&&(this.loaded=!0),t.forEach((t=>this.channelLoadCallback?.(this,t))),this.volumeDataObservers.forEach((e=>e.onVolumeData(this,t)))}setChannelDataFromAtlas(t,e,s,i,r,n="uint8"){this.channels[t].setFromAtlas(e,s,i,n,r[0],r[1],this.imageInfo.subregionSize),this.onChannelLoaded([t])}setChannelDataFromVolume(t,e,s,i="uint8"){const{subregionSize:r,atlasTileDims:n}=this.imageInfo;this.channels[t].setFromVolumeData(e,r.x,r.y,r.z,n.x*r.x,n.y*r.y,s[0],s[1],i),this.onChannelLoaded([t])}appendEmptyChannel(t,e){const s=this.imageInfo.numChannels,i=t||"channel_"+s,r=e||ys(s);this.numChannels+=1,this.channelNames.push(i),this.channelColorsDefault.push(r),this.channels.push(new As(i));for(let t=0;t<this.volumeDataObservers.length;++t)this.volumeDataObservers[t].onVolumeChannelAdded(this,s);return s}getIntensity(t,e,s,i){return this.channels[t].getIntensity(e,s,i)}getHistogram(t){return this.channels[t].getHistogram()}setLut(t,e){this.channels[t].setLut(e)}setColorPalette(t,e){this.channels[t].setColorPalette(e)}setColorPaletteAlpha(t,e){this.channels[t].setColorPaletteAlpha(e)}getRotation(){return this.imageInfo.transform.rotation.toArray()}getTranslation(){return this.voxelsToWorldSpace(this.imageInfo.transform.translation.toArray())}voxelsToWorldSpace(t){const e=1/Math.max(this.physicalSize.x,Math.max(this.physicalSize.y,this.physicalSize.z));return(new Z).fromArray(t).multiply(this.physicalPixelSize).multiplyScalar(e).toArray()}addVolumeDataObserver(t){this.volumeDataObservers.push(t)}removeVolumeDataObserver(t){if(t){const e=this.volumeDataObservers.indexOf(t);-1!==e&&this.volumeDataObservers.splice(e,1)}}removeAllVolumeDataObservers(){this.volumeDataObservers=[]}}class Bs{time=0;subregion=new $(new Z(0,0,0),new Z(1,1,1));useExplicitLevel=!1}class js{setPrefetchPriority(t){}syncMultichannelLoading(t){}updateFetchOptions(t){}async createVolume(t,e){const{imageInfo:s,loadSpec:i}=await this.createImageInfo(t),r=new Vs(s,i,this);return r.channelLoadCallback=e,r.imageMetadata=function(t){const e=new Ts(t),s=e.volumeSize.clone().multiply(e.physicalPixelSize),i={};return i.Dimensions={...e.subregionSize},i["Original dimensions"]={...e.originalSize},i["Physical size"]={x:s.x+e.spatialUnit,y:s.y+e.spatialUnit,z:s.z+e.spatialUnit},i["Physical size per pixel"]={x:e.physicalPixelSize.x+e.spatialUnit,y:e.physicalPixelSize.y+e.spatialUnit,z:e.physicalPixelSize.z+e.spatialUnit},i["Multiresolution levels"]=t.multiscaleLevelDims,i.Channels=t.combinedNumChannels,i["Time series frames"]=e.times||1,t.userData&&!function(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}(t.userData)&&(i["User data"]=t.userData),i}(s),r}async loadVolumeData(t,e,s){const i={...t.loadSpec,...e};return this.loadRawChannelData(t.imageInfo.imageInfo,i,((e,s)=>{e&&(t.imageInfo=new Ts(e),t.updateDimensions()),t.loadSpec={...s,...i}}),((e,i,r,n,a)=>{for(let o=0;o<e.length;o++){const h=e[o],l=i[o],c=r[o],u=n[o];a?t.setChannelDataFromAtlas(h,c,a[0],a[1],u,l):t.setChannelDataFromVolume(h,c,u,l),s?.(t,h)}}))}}const Ws=t=>t.every((e=>e===t[0])),Ys=(t,e,s)=>{for(let i=0;i<s;i++)t.push(e)},Zs=t=>{const e=t>>1;return e+Number(0!==e)};function Hs(t,e){t<e[0]&&(e[0]=t),t>e[1]&&(e[1]=t)}class Xs{constructor(t,e,s,i,r=!1){const n=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]];for(const e of t)Hs(e[0],n[0]),Hs(e[2],n[1]),Hs(e[3],n[2]),Hs(e[4],n[3]);this.directionStates=[],this.priorityDirectionStates=[];for(const[t,a]of n.flat().entries()){const n=t>>1,o=n+Number(0!==n);let h;if(1&t){const t=s.map((t=>Math.min(a+e[n],t[o]-1)));if(Ws(t))h=t[0];else{h=[];for(const[e,i]of t.entries())Ys(h,i,s[e][1])}}else h=Math.max(a-e[n],0);const l={direction:t,start:a,end:h,chunks:[]};i&&i.includes(t)?this.priorityDirectionStates.push(l):r||this.directionStates.push(l)}for(const e of t){for(const t of this.directionStates)e[Zs(t.direction)]===t.start&&t.chunks.push(e);for(const t of this.priorityDirectionStates)e[Zs(t.direction)]===t.start&&t.chunks.push(e)}}static*iterateDirections(t){let e=1;for(;t.length>0;){t=t.filter((t=>{const s=Array.isArray(t.end)?Math.max(...t.end):t.end;return 1&t.direction?t.start+e<=s:t.start-e>=s}));for(const s of t){const t=e*(1&s.direction?1:-1);for(const e of s.chunks){if(Array.isArray(s.end)&&e[Zs(s.direction)]+t>s.end[e[1]])continue;const i=e.slice();i[Zs(s.direction)]+=t,yield i}}e+=1}}*[Symbol.iterator](){if(this.priorityDirectionStates.length>0)for(const t of Xs.iterateDirections(this.priorityDirectionStates))yield t;for(const t of Xs.iterateDirections(this.directionStates))yield t}}const $s=class{constructor(t,e,s){this.baseStore=t,this.cache=e,this.queue=s}set(t,e){return Promise.resolve()}async getAndCache(t,e,s){const i=await this.baseStore.get(t,s);return this.cache&&i&&this.cache.insert(e,i),i}async get(t,e){if(!this.cache||[".zarray",".zgroup",".zattrs","zarr.json"].some((e=>t.endsWith(e))))return this.baseStore.get(t,e?.options);e?.reportKey&&e.reportKey(t,e.subscriber);let s=this.baseStore.url??"";""===s||s instanceof URL||s.endsWith("/")||(s+="/");const i=s+t.slice(1),r=this.cache.get(i);return r?new Uint8Array(r):this.queue&&e?this.queue.addRequest(i,e.subscriber,(()=>this.getAndCache(t,i,e?.options)),e.isPrefetch):this.getAndCache(t,i,e?.options)}};let Js=function(t){return t.UNKNOWN="unknown",t.NOT_FOUND="not_found",t.TOO_LARGE="too_large",t.LOAD_DATA_FAILED="load_data_failed",t.INVALID_METADATA="invalid_metadata",t.INVALID_MULTI_SOURCE_ZARR="invalid_multi_source_zarr",t}({});class Gs extends Error{constructor(t,e){super(t,e),this.name="VolumeLoadError",this.type=e?.type??Js.UNKNOWN}}function Qs(t="Unknown error occurred while loading volume data",e=Js.UNKNOWN,s){return i=>{if(void 0!==s&&i===s)return i;if(i instanceof Gs)throw i;throw console.log(`Error loading volume data: ${i}`),new Gs(t,{type:e,cause:i})}}i.A.set("NodeNotFoundError",qe._),i.A.set("KeyError",qe.e),i.A.set("VolumeLoadError",Gs);const Ks=([t,e,s])=>2+Number(t>-1)+Number(e>-1)+Number(s>-1);function ti(t,e,s){const i=[s,s,s,s,s];return e.forEach(((e,s)=>{if(e>=0){if(e>=t.length)throw new Gs(`Unexpected axis index in zarr: ${e}`,{type:Js.INVALID_METADATA});i[s]=t[e]}})),i}function ei(t,e){const s=t.coordinateTransformations;if(void 0===s)return console.warn("WARNING: OMEZarrLoader: no coordinate transformations for scale level."),[1,1,1,1,1];const i=s.find((t=>"scale"===t.type));return i?ti(i.scale.slice(),e,1):(console.warn('WARNING: OMEZarrLoader: no coordinate transformation of type "scale" for scale level.'),[1,1,1,1,1])}function si(t,e,s,i){const r=(e[2]>-1?t.shape[e[2]]:1)-(i[2]>-1?s.shape[i[2]]:1),n=t.shape[e[3]]-s.shape[i[3]],a=t.shape[e[4]]-s.shape[i[4]];return 0===r&&0===n&&0===a?0:r<=0&&n<=0&&a<=0?-1:r>=0&&n>=0&&a>=0?1:void 0}const ii=(t,e)=>Math.abs(t-e)<1e-5;function ri(t,e,s,i){const r=ei(t.multiscaleMetadata.datasets[e],t.axesTCZYX),n=ei(s.multiscaleMetadata.datasets[i],s.axesTCZYX);return ii(r[2],n[2])&&ii(r[3],n[3])&&ii(r[4],n[4])}function ni(t,e){return"object"==typeof t&&null!==t&&e in t}function ai(t,e,s="zarr"){if(!ni(t,e))throw new Gs(`${s} metadata is missing required entry "${e}"`,{type:Js.INVALID_METADATA})}function oi(t,e,s="zarr"){if(!Array.isArray(t[e]))throw new Gs(`${s} metadata entry "${e}" is not an array`,{type:Js.INVALID_METADATA})}const hi="chunk request cancelled",li={maxPrefetchDistance:[5,5,5,5],maxPrefetchChunks:30};class ci extends js{syncChannels=!1;constructor(t,e,s=li,i=[]){super(),this.sources=t,this.requestQueue=e,this.fetchOptions=s,this.priorityDirections=i}static async createLoader(t,e=0,s,i,r){i||(i=new cs(r?.concurrencyLimit,r?.prefetchConcurrencyLimit));const n=Array.isArray(t)?t:[t],a=Array.isArray(e)?e:[e],o=n.map((async(t,e)=>{const r=(h=new $s(new os(t),s,i),new Re(h??new Map)),o=await Ye(r,{kind:"group"}).catch(Qs(`Failed to open OME-Zarr data at ${t}`,Js.NOT_FOUND));var h;let l=a[Math.min(e,a.length-1)];l>o.attrs.multiscales?.length&&(console.warn(`WARNING: OMEZarrLoader: scene ${l} is invalid. Using scene 0.`),l=0),function(t,e=0,s="zarr"){ai(t,"multiscales",s),oi(t,"multiscales",s);const i=t.multiscales[e];if(!i)throw new Gs(`${s} metadata does not have requested multiscale level ${e}`,{type:Js.INVALID_METADATA});const r=`${s} multiscale ${e}${ni(i,"name")?` ("${i.name})`:""}`;ai(i,"axes",r),oi(i,"axes",r),i.axes.forEach(((t,e)=>ai(t,"name",`${r} axis ${e}`))),ai(i,"datasets",s),oi(i,"datasets",s),i.datasets.forEach(((t,e)=>ai(t,"path",`${r} dataset ${e}`)))}(o.attrs,l,n.length>1?`Zarr source ${e}`:"Zarr");const{multiscales:c,omero:u}=o.attrs,d=c[l],m=d.datasets.map((({path:e})=>Ye(r.resolve(e),{kind:"array"}).catch(Qs(`Failed to open scale level ${e} of OME-Zarr data at ${t}`,Js.NOT_FOUND))));return{scaleLevels:await Promise.all(m),multiscaleMetadata:d,omeroMetadata:u,axesTCZYX:function(t){const e=[-1,-1,-1,-1,-1],s=["t","c","z","y","x"];t.forEach(((t,i)=>{const r=s.indexOf(t.name);if(!(r>-1))throw new Gs(`Unrecognized axis in zarr: ${t.name}`,{type:Js.INVALID_METADATA});e[r]=i}));const i=-1===e[4];if(i||-1===e[3])throw new Gs(`Did not find ${i?"an X":"a Y"} axis in zarr`,{type:Js.INVALID_METADATA});return e}(d.axes),channelOffset:0}})),h=await Promise.all(o);let l=0;for(const t of h)t.channelOffset=l,l+=t.omeroMetadata?.channels.length??t.scaleLevels[0].shape[t.axesTCZYX[1]];!function(t){if(t.length<2)return;const e=Array.from({length:t.length},(()=>[])),s=Array.from({length:t.length},(()=>[])),i=new Array(t.length).fill(0);for(;i.every(((e,s)=>e<t[s].scaleLevels.length));){let r=!0,n=0,a=t[0],o=a.scaleLevels[i[0]];for(let e=1;e<t.length;e++){const s=t[e],h=s.scaleLevels[i[e]],l=si(o,a.axesTCZYX,h,s.axesTCZYX);if(l)r=!1,l>0&&(n=e,a=s,o=h);else{if(void 0===l)throw new Gs("Incompatible zarr arrays: pixel dimensions are mismatched",{type:Js.INVALID_MULTI_SOURCE_ZARR});ri(a,i[n],s,i[e])||console.warn("Incompatible zarr arrays: scale levels of equal size have different scale transformations");const t=a.axesTCZYX[0]>-1?o.shape[a.axesTCZYX[0]]:1,r=s.axesTCZYX[0]>-1?h.shape[s.axesTCZYX[0]]:1;t!==r&&console.warn(`Incompatible zarr arrays: different numbers of timesteps: ${t} vs ${r}`)}}if(r)for(let r=0;r<i.length;r++){const n=t[r],a=i[r];e[r].push(n.scaleLevels[a]),s[r].push(n.multiscaleMetadata.datasets[a]),i[r]+=1}else for(const[e,s]of i.entries()){const r=t[e],n=r.scaleLevels[s];0!==si(o,a.axesTCZYX,n,r.axesTCZYX)&&(i[e]+=1)}}if(0===t[0].scaleLevels.length)throw new Gs("Incompatible zarr arrays: no sets of scale levels found that matched in all sources",{type:Js.INVALID_MULTI_SOURCE_ZARR});for(let i=0;i<t.length;i++)t[i].scaleLevels=e[i],t[i].multiscaleMetadata.datasets=s[i]}(h);const c=r?.priorityDirections?r.priorityDirections.slice():void 0;return new ci(h,i,r,c)}getUnitSymbols(){const t=this.sources[0],e=t.axesTCZYX[4],s=t.multiscaleMetadata.axes[e].unit,i=Ns(s)||s||"",r=t.axesTCZYX[0],n=r>-1?t.multiscaleMetadata.axes[r].unit:void 0;return[i,Ns(n)||n||""]}getLevelShapesZYX(){const t=this.sources[0],[e,s,i]=t.axesTCZYX.slice(-3);return t.scaleLevels.map((({shape:t})=>[-1===e?1:t[e],t[s],t[i]]))}getScale(t){return ei(this.sources[0].multiscaleMetadata.datasets[t],this.sources[0].axesTCZYX)}orderByDimension(t,e=0){return function(t,e){const s=Ks(e),i=Array(s);return e.forEach(((e,r)=>{if(e>=0){if(e>=s)throw new Gs(`Unexpected axis index in zarr: ${e}`,{type:Js.INVALID_METADATA});i[e]=t[r]}})),i}(t,this.sources[e].axesTCZYX)}orderByTCZYX(t,e,s=0){return ti(t,this.sources[s].axesTCZYX,e)}matchChannelToSource(t){const e=this.sources.length-1,s=this.sources[e],i=s.scaleLevels[0].shape[s.axesTCZYX[1]],r=s.channelOffset+i;if(t>r)throw new Gs(`Volume channel index ${t} out of range (${r} channels available)`,{type:Js.INVALID_METADATA});const n=this.sources.findIndex((e=>e.channelOffset>t)),a=-1===n?e:n-1;return{sourceIndex:a,channelIndexInSource:t-this.sources[a].channelOffset}}setPrefetchPriority(t){this.priorityDirections=t}syncMultichannelLoading(t){this.syncChannels=t}updateFetchOptions(t){this.fetchOptions={...this.fetchOptions,...t}}loadDims(t){const[e,s]=this.getUnitSymbols(),i=this.maxExtent??new $(new Z(0,0,0),new Z(1,1,1)),r=qs(t.subregion,i).getSize(new Z),n=[1,1,r.z,r.y,r.x],a=this.sources[0].scaleLevels.map(((t,i)=>{const r=this.getScale(i);return{spaceUnit:e,timeUnit:s,shape:this.orderByTCZYX(t.shape,1).map(((t,e)=>Math.max(Math.ceil(t*n[e]),1))),spacing:this.orderByTCZYX(r,1),dataType:t.dtype}}));return Promise.resolve(a)}createImageInfo(t){const e=this.sources[0],[s,,i,r,n]=e.axesTCZYX,a=s>-1,o=i>-1,h=Us(t,this.getLevelShapesZYX()),l=e.scaleLevels[h].shape,[c,u]=this.getUnitSymbols(),d=this.sources[this.sources.length-1],m=d.axesTCZYX[1],p=m>-1,y=d.channelOffset+(p?d.scaleLevels[h].shape[m]:1);let f=1;if(a){f=l[s];for(let t=0;t<this.sources.length;t++){const e=this.sources[t].scaleLevels[h].shape,s=this.sources[t].axesTCZYX[0];e[s]<f&&(console.warn("The number of time points is not consistent across sources: ",e[s],f),f=e[s])}}this.maxExtent||(this.maxExtent=t.subregion.clone());const g=Fs(t.subregion,new Z(l[n],l[r],o?l[i]:1)).getSize(new Z),x=Ls(g.z,g.x,g.y),_=new Map,b=this.sources.flatMap((t=>{const e=function(t){if(t.omeroMetadata?.channels)return t.omeroMetadata.channels.map((({label:e},s)=>e??`Channel ${s+t.channelOffset}`));const e=t.scaleLevels[0].shape[t.axesTCZYX[1]];return Array.from({length:e},((e,s)=>`Channel ${s+t.channelOffset}`))}(t);return e.map((t=>{const e=_.get(t);return void 0!==e?(_.set(t,e+1),`${t} (${e})`):(_.set(t,1),t)}))})),w=e.scaleLevels.map(((t,e)=>({spaceUnit:c,timeUnit:u,shape:this.orderByTCZYX(t.shape,1),spacing:this.getScale(e),dataType:t.dtype}))),M={name:e.omeroMetadata?.name||"Volume",atlasTileDims:[x.x,x.y],subregionSize:[g.x,g.y,g.z],subregionOffset:[0,0,0],combinedNumChannels:y,channelNames:b,multiscaleLevel:h,multiscaleLevelDims:w,transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},v={...t,subregion:new $(new Z(0,0,0),new Z(1,1,1))};return Promise.resolve({imageInfo:M,loadSpec:v})}async prefetchChunk(t,e,s){const{store:i,path:r}=t,n=r.endsWith("/")?"":"/",a=r+n+this.orderByDimension(e).join("/");await i.get(a,{subscriber:s,isPrefetch:!0}).catch(Qs(`Unable to prefetch chunk with key ${a}`,Js.LOAD_DATA_FAILED,hi))}beginPrefetch(t,e){const s=t.map((({sourceIdx:t,key:e})=>{const s=Ks(this.sources[t].axesTCZYX),i=e.trim().split("/").slice(-s).filter((t=>""!==t)).map((t=>parseInt(t,10))),r=this.orderByTCZYX(i,0,t);return r[1]+=this.sources[t].channelOffset,r})),i=this.sources.map((t=>{const s=t.scaleLevels[e],i=s.shape.map(((t,e)=>Math.ceil(t/s.chunks[e])));return this.orderByTCZYX(i,1)})),r=new Xs(s,this.fetchOptions.maxPrefetchDistance,i,this.priorityDirections,this.fetchOptions.onlyPriorityDirections),n=this.requestQueue.addSubscriber();let a=0;for(const t of r){if(a>=this.fetchOptions.maxPrefetchChunks)break;const{sourceIndex:s,channelIndexInSource:i}=this.matchChannelToSource(t[1]),r=this.sources[s].scaleLevels[e];t[1]=i,this.prefetchChunk(r,t,n),a++}void 0!==this.prefetchSubscriber&&this.requestQueue.removeSubscriber(this.prefetchSubscriber,hi),this.prefetchSubscriber=n}updateImageInfoForLoad(t,e){const s=this.maxExtent??new $(new Z(0,0,0),new Z(1,1,1)),i=qs(e.subregion,s),r=Us({...e,subregion:i},this.getLevelShapesZYX()),n=this.sources[0].scaleLevels[r].shape,[a,o,h]=this.sources[0].axesTCZYX.slice(2),l=Fs(i,new Z(n[h],n[o],-1===a?1:n[a])),c=l.getSize(new Z),u=Ls(c.z,c.x,c.y);return{...t,atlasTileDims:[u.x,u.y],subregionSize:[c.x,c.y,c.z],subregionOffset:[l.min.x,l.min.y,l.min.z],multiscaleLevel:r}}async loadRawChannelData(t,e,s,i){const r=this.syncChannels,n=this.updateImageInfoForLoad(t,e);s(n);const{combinedNumChannels:a,multiscaleLevel:o}=n,h=e.channels??Array.from({length:a},((t,e)=>e)),l=this.requestQueue.addSubscriber(),c=[],u=[],d=[],m=[],p=[],y=h.map((async t=>{const s=new Z(...n.subregionOffset),a=s.clone().add(new Z(...n.subregionSize)),{sourceIndex:h,channelIndexInSource:y}=this.matchChannelToSource(t),f=[e.time,y,Ze(s.z,a.z),Ze(s.y,a.y),Ze(s.x,a.x)],g=this.sources[h].scaleLevels[o],x=this.orderByDimension(f,h),_=await async function(t,e=null,s={}){return async function(t,e,s,i){const r=t[Ue],n=new Je({selection:e,shape:t.shape,chunk_shape:t.chunks}),a=i.prepare(new r.TypedArray(n.shape.reduce(((t,e)=>t*e),1)),n.shape,r.get_strides(n.shape,s.order)),o=s.create_queue?.()??function(){const t=[];return{add:e=>t.push(e()),onIdle:()=>Promise.all(t)}}();for(const{chunk_coords:e,mapping:h}of n)o.add((()=>t.getChunk(e,s.opts).then((({data:t,shape:e,stride:s})=>{const r=i.prepare(t,e,s);i.set_from_chunk(a,r,h)})).catch((t=>{if(!(t instanceof qe.e))throw t;r.fill_value&&i.set_scalar(a,h.map((t=>t.to)).filter((t=>null!==t)),r.fill_value)}))));return await o.onIdle(),0===n.shape.length?function(t){return"get"in t?t.get(0):t[0]}(a.data):a}(t,e,s,ts)}(g,x,{opts:{subscriber:l,reportKey:(t,e)=>((t,e,s)=>{s===l&&c.push({sourceIdx:t,key:e})})(h,t,e)}}).catch(Qs("Could not load OME-Zarr volume data",Js.LOAD_DATA_FAILED,hi));if(void 0===_?.data)return;const b=function(t,e){let s=t[0],i=t[0];for(let e=0;e<t.length;e++){const r=t[e];r<s&&(s=r),r>i&&(i=r)}if("float64"===e){const s=new Float32Array(t.length);for(let e=0;e<t.length;e++)s[e]=t[e];e="float32",t=s}return{data:t,dtype:e,min:s,max:i}}(_.data,g.dtype);r?(m.push(b.dtype),d.push(b.data),u.push(t),p.push([b.min,b.max])):i([t],[b.dtype],[b.data],[[b.min,b.max]])}));void 0!==this.loadSubscriber&&this.requestQueue.removeSubscriber(this.loadSubscriber,hi),this.loadSubscriber=l,this.beginPrefetch(c,o),await Promise.all(y),r&&i(u,m,d,p),this.requestQueue.removeSubscriber(l,hi)}}let ui=function(t){return t[t.MILLISECOND=0]="MILLISECOND",t[t.SECOND=1]="SECOND",t[t.MINUTE=2]="MINUTE",t[t.HOUR=3]="HOUR",t[t.DAY=4]="DAY",t}({});ui.MILLISECOND,new Set(["ms","millisecond","milliseconds"]),ui.SECOND,new Set(["s","sec","second","seconds"]),ui.MINUTE,new Set(["m","min","minute","minutes"]),ui.HOUR,new Set(["h","hr","hour","hours"]),ui.DAY,new Set(["d","day","days"]);function di(t){let e=t[0],s=t[0];for(let i=1;i<t.length;i++)e=Math.min(e,t[i]),s=Math.max(s,t[i]);return[e,s]}ui.MILLISECOND,ui.SECOND,ui.MINUTE,ui.HOUR,ui.DAY;const mi=t=>[t.pixel_size_x*t.width/t.tile_width,t.pixel_size_y*t.height/t.tile_height,t.pixel_size_z],pi=t=>{const[e,s,i]=mi(t),r=t.transform?.translation??[0,0,0];return r[0]=r[0]*t.tile_width/t.width,r[1]=r[1]*t.tile_height/t.height,{name:t.name,atlasTileDims:[t.cols,t.rows],subregionSize:[t.tile_width,t.tile_height,t.tiles],subregionOffset:[0,0,0],combinedNumChannels:t.channels,channelNames:t.channel_names,channelColors:t.channel_colors,multiscaleLevel:0,multiscaleLevelDims:[{shape:[t.times||1,t.channels,t.tiles,t.tile_height,t.tile_width],spacing:[t.time_scale||1,1,i,s,e],spaceUnit:t.pixel_size_unit||"μm",timeUnit:t.time_unit||"s",dataType:"uint8"}],transform:{translation:r,rotation:t.transform?.rotation?t.transform.rotation:[0,0,0],scale:[1,1,1]},userData:{...t.userData,originalVolumeSize:[t.width,t.height,t.tiles],originalPhysicalPixelSize:[t.pixel_size_x,t.pixel_size_y,t.pixel_size_z]}}};class yi extends js{syncChannels=!1;constructor(t,e){super(),Array.isArray(t)?this.urls=t:this.urls=[t],this.jsonInfo=new Array(this.urls.length),this.cache=e}async getJsonImageInfo(t){const e=this.jsonInfo[t];if(e)return e;const s=await fetch(this.urls[t]),i=await s.json();return i.pixel_size_unit=i.pixel_size_unit||"μm",i.times=i.times||this.urls.length,this.jsonInfo[t]=i,i}syncMultichannelLoading(t){this.syncChannels=t}async loadDims(t){const e=await this.getJsonImageInfo(t.time),[s,i,r]=mi(e);return[{shape:[e.times||1,e.channels,e.tiles,e.tile_height,e.tile_width],spacing:[1,1,r,i,s],spaceUnit:e.pixel_size_unit??"μm",dataType:"uint8",timeUnit:e.time_unit??"s"}]}async createImageInfo(t){const e=await this.getJsonImageInfo(t.time);return{imageInfo:pi(e),loadSpec:t}}async loadRawChannelData(t,e,s,i){const r=await this.getJsonImageInfo(e.time);let n=r?.images;if(!n)return;const a=e.channels;a&&(n=n.filter((({channels:t})=>t.some((t=>a.includes(t))))));const o=this.urls[e.time].replace(/[^/]*$/,"");n=n.map((t=>({...t,name:o+t.name}))),s(void 0,{...e,subregion:new $(new Z(0,0,0),new Z(1,1,1)),multiscaleLevel:0,channels:n.flatMap((({channels:t})=>t))});const[h,l]=function(t){const{atlasTileDims:e}=t,s=t.multiscaleLevelDims[t.multiscaleLevel];return[e[0]*s.shape[4],e[1]*s.shape[3]]}(t);await yi.loadVolumeAtlasData(n,((t,e,s,r)=>i(t,e,s,r,[h,l])),this.cache,this.syncChannels)}static async loadVolumeAtlasData(t,e,s,i=!1){const r=[],n=[],a=[],o=[],h=t.map((async t=>{let h=!0;for(let l=0;l<Math.min(t.channels.length,4);++l){const c=t.channels[l],u=s?.get(`${t.name}/${c}`);if(!u){h=!1;break}{const t=new Uint8Array(u);i?(r.push(c),n.push("uint8"),a.push(t),o.push(di(t))):e([c],["uint8"],[t],[di(t)])}}if(h)return;const l=await fetch(t.name,{mode:"cors"}),c=await l.blob(),u=await createImageBitmap(c),d=new OffscreenCanvas(u.width,u.height).getContext("2d");if(!d)return void console.log("Error creating canvas 2d context for "+t.name);d.globalCompositeOperation="copy",d.globalAlpha=1,d.drawImage(u,0,0);const m=d.getImageData(0,0,u.width,u.height),p=[],y=u.width*u.height;for(let e=0;e<Math.min(t.channels.length,4);++e)p.push(new Uint8Array(y));const f=[];for(let e=0;e<Math.min(t.channels.length,4);++e){let t=1/0,s=-1/0;for(let i=0;i<y;i++)p[e][i]=m.data[4*i+e],t=Math.min(t,p[e][i]),s=Math.max(s,p[e][i]);f[e]=[t,s]}for(let h=0;h<Math.min(t.channels.length,4);++h){const l=t.channels[h];s?.insert(`${t.name}/${l}`,p[h]),i?(r.push(l),n.push("uint8"),a.push(p[h]),o.push(f[h])):e([l],["uint8"],[p[h]],[f[h]],[u.width,u.height])}}));await Promise.all(h),i&&e(r,n,a,o)}}const fi=t=>{const e=Ls(t.sizeZ,t.sizeX,t.sizeY);return{name:t.name,atlasTileDims:[e.x,e.y],subregionSize:[t.sizeX,t.sizeY,t.sizeZ],subregionOffset:[0,0,0],combinedNumChannels:t.sizeC,channelNames:t.channelNames,channelColors:void 0,multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,t.sizeC,t.sizeZ,t.sizeY,t.sizeX],spacing:[1,1,t.physicalPixelSize[2],t.physicalPixelSize[1],t.physicalPixelSize[0]],spaceUnit:t.spatialUnit||"μm",timeUnit:"s",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},userData:t.userData}};class gi extends js{constructor(t,e){if(super(),this.jsonInfo=e,this.data=t,this.data.shape[0]!==this.jsonInfo.sizeC||this.data.shape[1]!==this.jsonInfo.sizeZ||this.data.shape[2]!==this.jsonInfo.sizeY||this.data.shape[3]!==this.jsonInfo.sizeX)throw new Error("RawArrayLoader: data shape does not match metadata")}async loadDims(t){const e=this.jsonInfo;return[{shape:[1,e.sizeC,e.sizeZ,e.sizeY,e.sizeX],spacing:[1,1,e.physicalPixelSize[2],e.physicalPixelSize[1],e.physicalPixelSize[0]],spaceUnit:e.spatialUnit||"μm",dataType:"uint8",timeUnit:"s"}]}async createImageInfo(t){return{imageInfo:fi(this.jsonInfo),loadSpec:t}}loadRawChannelData(t,e,s,i){const r=e.channels;s(void 0,{...e,subregion:new $(new Z(0,0,0),new Z(1,1,1)),multiscaleLevel:0});for(let e=0;e<t.combinedNumChannels;++e){if(r&&r.length>0&&!r.includes(e))continue;const t=this.data.shape[3]*this.data.shape[2]*this.data.shape[1],s=new Uint8Array(this.data.buffer.buffer,e*t,t);i([e],["uint8"],[s],[di(s)])}return Promise.resolve()}}var xi=s(4276);class _i{sizex=0;sizey=0;sizez=1;sizec=1;sizet=1;unit="";pixeltype="";dimensionorder="";pixelsizex=1;pixelsizey=1;pixelsizez=1;channelnames=[]}function bi(t){const e={uint8:"uint8",uint16:"uint16",uint32:"uint32",int8:"int8",int16:"int16",int32:"int32",float:"float32"}[t];return void 0===e?(console.warn(`Unsupported OME pixel type ${t}; defaulting to uint8`),"uint8"):e}function wi(t,e){const s=t.getAttribute(e);if(null===s)throw new Gs(`Missing attribute ${e} in OME-TIFF metadata`,{type:Js.INVALID_METADATA});return s}class Mi extends js{constructor(t){super(),this.url=t}async loadOmeDims(){if(!this.dims){const t=await(0,xi.uz)(this.url,{allowFullFile:!0}).catch(Qs(`Could not open TIFF file at ${this.url}`,Js.NOT_FOUND)),e=function(t){const e=new DOMParser;try{return e.parseFromString(t,"text/xml").getElementsByTagName("OME")[0]}catch(t){throw new Gs("Could not find OME metadata in TIFF file",{type:Js.INVALID_METADATA,cause:t})}}((await t.getImage().catch(Qs("Failed to open TIFF image",Js.NOT_FOUND))).getFileDirectory().ImageDescription.trim().replace(/[\u0000]$/g,"").trim()).getElementsByTagName("Image")[0];this.dims=function(t){const e=new _i,s=t.getElementsByTagName("Pixels")[0];e.sizex=Number(wi(s,"SizeX")),e.sizey=Number(wi(s,"SizeY")),e.sizez=Number(s.getAttribute("SizeZ")),e.sizec=Number(s.getAttribute("SizeC")),e.sizet=Number(s.getAttribute("SizeT")),e.unit=s.getAttribute("PhysicalSizeXUnit")||"",e.pixeltype=s.getAttribute("Type")||"",e.dimensionorder=s.getAttribute("DimensionOrder")||"XYZCT",e.pixelsizex=Number(s.getAttribute("PhysicalSizeX")),e.pixelsizey=Number(s.getAttribute("PhysicalSizeY")),e.pixelsizez=Number(s.getAttribute("PhysicalSizeZ"));const i=s.getElementsByTagName("Channel");for(let t=0;t<i.length;++t){const s=i[t].getAttribute("Name"),r=i[t].getAttribute("ID");e.channelnames.push(s||r||"Channel"+t)}return e}(e)}return this.dims}async loadDims(t){const e=await this.loadOmeDims(),s=Ls(e.sizez,e.sizex,e.sizey),i=Cs,r=Math.floor(i/s.x),n=Math.floor(i/s.y);return[{shape:[e.sizet,e.sizec,e.sizez,n,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/n,e.pixelsizex*e.sizex/r],spaceUnit:e.unit?e.unit:"micron",dataType:bi(e.pixeltype),timeUnit:"s"}]}async createImageInfo(t){const e=await this.loadOmeDims(),s=Ls(e.sizez,e.sizex,e.sizey),i=Cs,r=Math.floor(i/s.x),n=Math.floor(i/s.y);return{imageInfo:{name:"TEST",atlasTileDims:[s.x,s.y],subregionSize:[r,n,e.sizez],subregionOffset:[0,0,0],combinedNumChannels:e.sizec,channelNames:e.channelnames,multiscaleLevel:0,multiscaleLevelDims:[{shape:[e.sizet,e.sizec,e.sizez,n,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/n,e.pixelsizex*e.sizex/r],spaceUnit:e.unit||"",timeUnit:"",dataType:bi(e.pixeltype)}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},loadSpec:new Bs}}async loadRawChannelData(t,e,i,r){const n=await this.loadOmeDims(),a=new Ts(t).volumeSize,o=[];for(let e=0;e<t.combinedNumChannels;++e){const i=new Promise(((i,o)=>{const h={channel:e,tilesizex:a.x,tilesizey:a.y,sizec:t.combinedNumChannels,sizez:a.z,dimensionOrder:n.dimensionorder,bytesPerSample:(l=n.pixeltype,"uint8"===l?1:"uint16"===l?2:4),url:this.url};var l;const u=new Worker(new URL(s.p+s.u(647),s.b));u.onmessage=t=>{if(t.data.isError)return void o(c(t.data.error));const{data:e,dtype:s,channel:n,range:a}=t.data;r([n],[s],[e],[a]),u.terminate(),i()},u.postMessage(h)}));o.push(i)}await Promise.all(o)}}let vi=function(t){return t.ZARR="zarr",t.JSON="json",t.TIFF="tiff",t.DATA="data",t}({});function zi(t){return t.endsWith(".json")?vi.JSON:t.endsWith(".tif")||t.endsWith(".tiff")?vi.TIFF:vi.ZARR}let Si,Ai,Ei,Ti,Ci=function(t){return t[t.INIT=0]="INIT",t[t.CREATE_LOADER=1]="CREATE_LOADER",t[t.CREATE_VOLUME=2]="CREATE_VOLUME",t[t.LOAD_DIMS=3]="LOAD_DIMS",t[t.LOAD_VOLUME_DATA=4]="LOAD_VOLUME_DATA",t[t.SET_PREFETCH_PRIORITY_DIRECTIONS=5]="SET_PREFETCH_PRIORITY_DIRECTIONS",t[t.SYNCHRONIZE_MULTICHANNEL_LOADING=6]="SYNCHRONIZE_MULTICHANNEL_LOADING",t[t.UPDATE_FETCH_OPTIONS=7]="UPDATE_FETCH_OPTIONS",t}({}),Ii=function(t){return t[t.SUCCESS=0]="SUCCESS",t[t.ERROR=1]="ERROR",t[t.EVENT=2]="EVENT",t}({}),ki=function(t){return t[t.METADATA_UPDATE=0]="METADATA_UPDATE",t[t.CHANNEL_LOAD=1]="CHANNEL_LOAD",t}({});function Di(t){return{...t,subregion:new $((new Z).copy(t.subregion.min),(new Z).copy(t.subregion.max))}}let Ni=!1,Li=!1;const Oi={[Ci.INIT]:({maxCacheSize:t,maxActiveRequests:e,maxLowPriorityRequests:s})=>(Ni||(Si=new d(t),Ai=new ls(e,s),Ei=new cs(Ai),Ni=!0),Promise.resolve()),[Ci.CREATE_LOADER]:async({path:t,options:e})=>{const s=Array.isArray(t)?t[0]:t,i=e?.fileType||zi(s);return Li=i===vi.JSON,Ti=await async function(t,e){const s=Array.isArray(t)?t[0]:t;switch(e?.fileType||zi(s)){case vi.ZARR:return await ci.createLoader(t,e?.scene,e?.cache,e?.queue,e?.fetchOptions);case vi.JSON:return new yi(t,e?.cache);case vi.TIFF:return new Mi(s);case vi.DATA:if(!e?.rawArrayOptions)throw new Error("Must provide RawArrayOptions for RawArrayLoader");return new gi(e?.rawArrayOptions.data,e?.rawArrayOptions.metadata)}}(t,{...e,cache:Si,queue:Ei}),void 0!==Ti},[Ci.CREATE_VOLUME]:async t=>{if(void 0===Ti)throw new Gs("No loader created");return await Ti.createImageInfo(Di(t))},[Ci.LOAD_DIMS]:async t=>{if(void 0===Ti)throw new Gs("No loader created");return await Ti.loadDims(Di(t))},[Ci.LOAD_VOLUME_DATA]:({imageInfo:t,loadSpec:e,loaderId:s,loadId:i})=>{if(void 0===Ti)throw new Gs("No loader created");return Ti.loadRawChannelData(t,Di(e),((t,e)=>{const r={responseResult:Ii.EVENT,eventType:ki.METADATA_UPDATE,loaderId:s,loadId:i,imageInfo:t,loadSpec:e};self.postMessage(r)}),((t,e,r,n,a)=>{const o={responseResult:Ii.EVENT,eventType:ki.CHANNEL_LOAD,loaderId:s,loadId:i,channelIndex:t,dtype:e,data:r,ranges:n,atlasDims:a};self.postMessage(o,Li?[]:r.map((t=>t.buffer)))}))},[Ci.SET_PREFETCH_PRIORITY_DIRECTIONS]:t=>(Ti?.setPrefetchPriority(t),Promise.resolve()),[Ci.SYNCHRONIZE_MULTICHANNEL_LOADING]:t=>(Ti?.syncMultichannelLoading(t),Promise.resolve()),[Ci.UPDATE_FETCH_OPTIONS]:t=>(Ti?.updateFetchOptions(t),Promise.resolve())};self.onmessage=async({data:t})=>{const{msgId:e,type:s,payload:i}=t;let r;try{const t=await Oi[s](i);r={responseResult:Ii.SUCCESS,msgId:e,type:s,payload:t}}catch(t){r={responseResult:Ii.ERROR,msgId:e,type:s,payload:l(t)}}self.postMessage(r)}}}]);
//# sourceMappingURL=423.bundle.js.map